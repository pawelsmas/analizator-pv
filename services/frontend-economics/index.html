<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Analiza Ekonomiczna</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="economics-container">
  <!-- Sidebar with parameters -->
  <div class="sidebar">
    <div class="section-title">üí∞ PARAMETRY EKONOMICZNE</div>

    <label>Stawka za energiƒô czynnƒÖ [PLN/MWh]</label>
    <input type="number" id="energyActive" value="550" step="10">

    <label>Dystrybucja [PLN/MWh]</label>
    <input type="number" id="distribution" value="200" step="10">

    <label>Op≈Çata jako≈õciowa [PLN/MWh]</label>
    <input type="number" id="qualityFee" value="10" step="1">

    <label>Op≈Çata OZE [PLN/MWh]</label>
    <input type="number" id="ozeFee" value="7" step="1">

    <label>Op≈Çata kogeneracyjna [PLN/MWh]</label>
    <input type="number" id="cogenerationFee" value="10" step="1">

    <label>Op≈Çata mocowa (7-21) [PLN/MWh]</label>
    <input type="number" id="capacityFee" value="219" step="10">

    <label>Akcyza [PLN/MWh]</label>
    <input type="number" id="exciseTax" value="5" step="1">

    <div class="section-title" style="margin-top:24px">üèóÔ∏è PARAMETRY INSTALACJI</div>

    <label>Koszt inwestycji [PLN/kWp]</label>
    <input type="number" id="investmentCost" value="3500" step="100">

    <label>OPEX [PLN/kWp/rok]</label>
    <input type="number" id="opexPerKwp" value="15" step="1">

    <div class="row">
      <div>
        <label>Degradacja [%/rok]</label>
        <input type="number" id="degradationRate" value="0.5" step="0.1" min="0" max="2">
      </div>
      <div>
        <label>Okres analizy [lat]</label>
        <input type="number" id="analysisPeriod" value="25" step="1" min="10" max="30">
      </div>
    </div>

    <button class="btn" onclick="recalculateEconomics()">PRZELICZ ANALIZƒò</button>
    <button class="btn btn-secondary" onclick="resetToDefaults()">PRZYWR√ìƒÜ DOMY≈öLNE</button>
  </div>

  <div class="content">
    <div class="page-header">
      <h1>ANALIZA EKONOMICZNA INSTALACJI PV</h1>
      <div class="header-info">
        <span id="dataInfo">Brak danych ekonomicznych</span>
      </div>
      <div class="header-info" id="bessInfoLine" style="display:none;margin-top:6px;color:#00e676;font-size:14px;font-weight:600;">
        <span>üîã <span id="bessInfoText">-</span></span>
      </div>
    </div>

    <!-- Global Production Scenario Selector - FLOATING/STICKY -->
    <div id="globalScenarioSelector" style="position:fixed;top:10px;right:20px;z-index:9999;background:linear-gradient(135deg,#3f51b5,#5c6bc0);padding:12px 20px;border-radius:12px;display:flex;align-items:center;gap:16px;box-shadow:0 4px 20px rgba(63,81,181,0.4)">
      <div style="display:flex;align-items:center;gap:8px">
        <span style="font-size:18px">üìä</span>
        <div style="font-size:12px;font-weight:600;color:white">Scenariusz:</div>
      </div>
      <div style="display:flex;gap:6px;align-items:center">
        <button id="globalBtnP50" class="scenario-btn active" onclick="setGlobalScenario('P50')" style="padding:8px 16px;border:2px solid #27ae60;background:#27ae60;color:white;border-radius:6px;font-weight:700;cursor:pointer;font-size:13px;transition:all 0.2s">
          P50
        </button>
        <button id="globalBtnP75" class="scenario-btn" onclick="setGlobalScenario('P75')" style="padding:8px 16px;border:2px solid #3498db;background:white;color:#3498db;border-radius:6px;font-weight:700;cursor:pointer;font-size:13px;transition:all 0.2s">
          P75
        </button>
        <button id="globalBtnP90" class="scenario-btn" onclick="setGlobalScenario('P90')" style="padding:8px 16px;border:2px solid #e74c3c;background:white;color:#e74c3c;border-radius:6px;font-weight:700;cursor:pointer;font-size:13px;transition:all 0.2s">
          P90
        </button>
      </div>
      <div id="scenarioFactorDisplay" style="font-size:11px;color:rgba(255,255,255,0.8);margin-left:4px">100%</div>
    </div>
    <!-- Spacer for fixed selector -->
    <div style="height:10px"></div>

    <div class="content-grid">
    <!-- BESS Source Selector -->
    <div id="bessSourceSection" class="bess-source-section" style="display:none;background:#f8f9fa;border:1px solid #dee2e6;border-radius:8px;padding:12px 16px;margin-bottom:16px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-weight:600;color:#495057;">üîã ≈πr√≥d≈Ço danych BESS:</span>
          <select id="bessSourceSelect" onchange="changeBessSource()" style="padding:6px 12px;border:1px solid #ced4da;border-radius:4px;font-size:13px;background:white;cursor:pointer;">
            <option value="pv-calculation">Konfiguracja (BESS LIGHT/PRO)</option>
            <option value="profile-analysis">Analiza Profilu (rekomendacja)</option>
          </select>
        </div>
        <div id="bessSourceInfo" style="display:flex;gap:20px;font-size:12px;color:#6c757d;">
          <div id="bessSourceConfig" style="display:none;">
            <span style="font-weight:500;">Konfiguracja:</span>
            <span id="bessConfigPower">-</span> kW / <span id="bessConfigEnergy">-</span> kWh
          </div>
          <div id="bessSourceProfile" style="display:none;">
            <span style="font-weight:500;">Profil:</span>
            <span id="bessProfilePower">-</span> kW / <span id="bessProfileEnergy">-</span> kWh
          </div>
        </div>
      </div>
      <div id="bessSourceWarning" style="display:none;margin-top:8px;padding:8px;background:#fff3cd;border-radius:4px;font-size:12px;color:#856404;">
        ‚ö†Ô∏è Wybrane ≈∫r√≥d≈Ço BESS r√≥≈ºni siƒô od danych w wariancie. Obliczenia ekonomiczne u≈ºywajƒÖ wybranego ≈∫r√≥d≈Ça.
      </div>
    </div>

    <!-- Wska≈∫niki kluczowe -->
    <div class="stats-section">
      <h2>Kluczowe Wska≈∫niki Ekonomiczne</h2>
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-icon">üí∞</div>
          <div class="stat-content">
            <div class="stat-label">Nak≈Çady Inwestycyjne</div>
            <div class="stat-value" id="capex">-</div>
            <div class="stat-unit">mln PLN</div>
            <div class="stat-breakdown" id="capexBreakdown" style="font-size:11px;color:#666;margin-top:4px;display:none;">
              <div>‚òÄÔ∏è PV: <span id="capexPV">-</span> mln</div>
              <div>üîã BESS: <span id="capexBESS">-</span> mln</div>
            </div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚è±Ô∏è</div>
          <div class="stat-content">
            <div class="stat-label">Okres Zwrotu</div>
            <div class="stat-value" id="paybackPeriod">-</div>
            <div class="stat-unit">lat</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìà</div>
          <div class="stat-content">
            <div class="stat-label">NPV</div>
            <div class="stat-value" id="npv">-</div>
            <div class="stat-unit">mln PLN</div>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-content">
            <div class="stat-label">IRR</div>
            <div class="stat-value" id="irr">-</div>
            <div class="stat-unit">%</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SKAN WARIANT√ìW - Autokonsumpcja vs Pokrycie -->
    <div class="chart-section full-width variant-scan-section">
      <h2>üìä Skan Wariant√≥w - Analiza Mocy Instalacji</h2>
      <div class="chart-info">
        Por√≥wnanie autokonsumpcji i pokrycia zu≈ºycia dla r√≥≈ºnych mocy PV
        <span class="breakeven-selector">
          | Optimum:
          <label><input type="radio" name="breakevenMode" value="npv" checked onchange="updateBreakevenMode(this.value)"> Max NPV</label>
          <label><input type="radio" name="breakevenMode" value="payback" onchange="updateBreakevenMode(this.value)"> Min Payback</label>
        </span>
      </div>

      <!-- Placeholder gdy brak danych -->
      <div id="variantScanNoData" class="variant-scan-no-data">
        <div class="no-data-icon">üìä</div>
        <p>Wykonaj symulacjƒô PV w module <strong>Konfiguracja</strong> lub <strong>Produkcja PV</strong>, aby zobaczyƒá analizƒô wariant√≥w mocy.</p>
      </div>

      <div class="variant-scan-container" id="variantScanContent" style="display: none;">
        <!-- Wykres -->
        <div class="variant-scan-chart">
          <canvas id="variantScanChart"></canvas>
        </div>

        <!-- Tabela -->
        <div class="variant-scan-table-wrapper">
          <table id="variantScanTable" class="variant-scan-table">
            <thead>
              <tr>
                <th>Moc<br/><span class="unit">kWp</span></th>
                <th>Produkcja<br/><span class="unit">MWh/rok</span></th>
                <th>Autokons.<br/><span class="unit">%</span></th>
                <th>Pokrycie<br/><span class="unit">%</span></th>
                <th>Eksport<br/><span class="unit">MWh</span></th>
                <th>NPV<br/><span class="unit">mln PLN</span></th>
                <th>Payback<br/><span class="unit">lat</span></th>
                <th>LCOE<br/><span class="unit">PLN/MWh</span></th>
              </tr>
            </thead>
            <tbody id="variantScanTableBody">
              <!-- Dynamicznie wype≈Çnione przez JavaScript -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="variant-scan-footer">
        <div class="variant-scan-observation">
          <strong>üìà Obserwacja:</strong> <span id="variantScanObservation">Wraz ze wzrostem mocy instalacji powy≈ºej pewnego progu, autokonsumpcja spada, co oznacza, ≈ºe dodatkowa moc generuje g≈Ç√≥wnie nadwy≈ºki eksportowane do sieci w godzinach niskich cen.</span>
        </div>
        <button class="btn btn-export" onclick="exportVariantScanToExcel()" title="Eksportuj do Excel">
          üì• Eksport Excel
        </button>
      </div>
    </div>

    <!-- Przep≈Çywy pieniƒô≈ºne -->
    <div class="chart-section full-width">
      <h2>Przep≈Çywy Pieniƒô≈ºne</h2>
      <div class="chart-info">
        Skumulowane przep≈Çywy w okresie 25 lat
      </div>
      <canvas id="cashFlow"></canvas>
    </div>

    <!-- Przychody vs Koszty -->
    <div class="chart-section">
      <h2>Przychody i Koszty Roczne</h2>
      <div class="chart-info">
        Por√≥wnanie przychod√≥w z kosztami w czasie
      </div>
      <canvas id="revenueVsCosts"></canvas>
    </div>

    <!-- Tabela przychod√≥w i koszt√≥w -->
    <div class="chart-section">
      <h2>Szczeg√≥≈Çowa Tabela Przychod√≥w i Koszt√≥w</h2>
      <div class="chart-info">
        Warto≈õci numeryczne dla pierwszych 10 lat ‚Ä¢ <button class="btn-link" onclick="exportRevenueToExcel()">üì• Pobierz Excel (25 lat)</button>
      </div>
      <div class="table-wrapper">
        <table id="revenueTable" class="revenue-table">
          <thead>
            <tr>
              <th>Rok</th>
              <th>Oszczƒôdno≈õci<br/><span class="unit">tys. PLN</span></th>
              <th>OPEX<br/><span class="unit">tys. PLN</span></th>
              <th>Zysk netto<br/><span class="unit">tys. PLN</span></th>
              <th>Mar≈ºa<br/><span class="unit">%</span></th>
            </tr>
          </thead>
          <tbody id="revenueTableBody">
            <!-- Wype≈Çnione dynamicznie przez JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- EaaS Analysis -->
    <div class="chart-section full-width" id="eaasSection">
      <h2>üìä Analiza EaaS (Energy-as-a-Service)</h2>
      <div class="chart-info">
        Por√≥wnanie modelu subskrypcyjnego z CAPEX
      </div>

      <div style="background:#e8f5e9;padding:20px;border-radius:8px;margin-bottom:20px;border-left:4px solid #4caf50">
        <div style="font-size:14px;font-weight:600;color:#2e7d32;margin-bottom:12px">
          üí° Abonament EaaS obliczany automatycznie
        </div>
        <div style="font-size:13px;color:#1b5e20;margin-bottom:16px;line-height:1.6">
          System automatycznie oblicza abonament EaaS na podstawie:<br>
          ‚Ä¢ Wielko≈õci instalacji (CAPEX z przedzia≈Ç√≥w)<br>
          ‚Ä¢ Koszt√≥w operacyjnych (OPEX, ubezpieczenie)<br>
          ‚Ä¢ Docelowego IRR dla ESCO (z modu≈Çu USTAWIENIA)<br>
          ‚Ä¢ Okresu umowy i typu indeksacji (z modu≈Çu USTAWIENIA)
        </div>

        <!-- Calculated subscription display - Basic -->
        <div id="eaasSubscriptionDisplay" style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;background:#fff;padding:16px;border-radius:6px;margin-bottom:16px">
          <div style="text-align:center">
            <div style="font-size:12px;color:#666;margin-bottom:4px">Roczny abonament</div>
            <div id="eaasAnnualSub" style="font-size:20px;font-weight:700;color:#2e7d32">‚Äì</div>
            <div id="eaasAnnualSubUnit" style="font-size:11px;color:#888">PLN/rok</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:12px;color:#666;margin-bottom:4px">Miesiƒôczna rata</div>
            <div id="eaasMonthlySub" style="font-size:20px;font-weight:700;color:#27ae60">‚Äì</div>
            <div id="eaasMonthlySubUnit" style="font-size:11px;color:#888">PLN/mies</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:12px;color:#666;margin-bottom:4px">Cena EaaS</div>
            <div id="eaasPricePerMWh" style="font-size:20px;font-weight:700;color:#9c27b0">‚Äì</div>
            <div id="eaasPricePerMWhUnit" style="font-size:11px;color:#888">PLN/MWh</div>
          </div>
          <div style="text-align:center">
            <div style="font-size:12px;color:#666;margin-bottom:4px">Okres umowy</div>
            <div id="eaasDurationDisplay" style="font-size:20px;font-weight:700;color:#e67e22">‚Äì</div>
            <div style="font-size:11px;color:#888">lat</div>
          </div>
        </div>

        <!-- Full Investor Model Display -->
        <div id="eaasFullModelDisplay" style="display:none;background:#fff;padding:16px;border-radius:6px;margin-bottom:16px;border:2px solid #1976d2">
          <div style="font-size:14px;font-weight:600;color:#1976d2;margin-bottom:12px">
            üìà Pe≈Çny Model Inwestora
          </div>

          <!-- IRR Metrics -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:16px">
            <div style="text-align:center;background:#e3f2fd;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Target IRR</div>
              <div id="eaasTargetIRR" style="font-size:18px;font-weight:700;color:#1565c0">‚Äì</div>
              <div style="font-size:10px;color:#888">%</div>
            </div>
            <div style="text-align:center;background:#e8f5e9;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Project IRR</div>
              <div id="eaasProjectIRR" style="font-size:18px;font-weight:700;color:#2e7d32">‚Äì</div>
              <div style="font-size:10px;color:#888">%</div>
            </div>
            <div style="text-align:center;background:#fff3e0;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Equity IRR</div>
              <div id="eaasEquityIRR" style="font-size:18px;font-weight:700;color:#e65100">‚Äì</div>
              <div style="font-size:10px;color:#888">%</div>
            </div>
            <div style="text-align:center;background:#fce4ec;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">IRR Driver</div>
              <div id="eaasIrrDriver" style="font-size:18px;font-weight:700;color:#c2185b">‚Äì</div>
              <div style="font-size:10px;color:#888">waluta</div>
            </div>
          </div>

          <!-- Financing Structure -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:16px">
            <div style="text-align:center">
              <div style="font-size:11px;color:#666;margin-bottom:4px">CAPEX</div>
              <div id="eaasTotalCapex" style="font-size:16px;font-weight:600;color:#2c3e50">‚Äì</div>
              <div style="font-size:10px;color:#888">mln PLN</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:11px;color:#666;margin-bottom:4px">D≈Çug</div>
              <div id="eaasDebtAmount" style="font-size:16px;font-weight:600;color:#d32f2f">‚Äì</div>
              <div style="font-size:10px;color:#888">mln PLN</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Kapita≈Ç w≈Çasny</div>
              <div id="eaasEquityAmount" style="font-size:16px;font-weight:600;color:#388e3c">‚Äì</div>
              <div style="font-size:10px;color:#888">mln PLN</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Leverage</div>
              <div id="eaasLeverageRatio" style="font-size:16px;font-weight:600;color:#7b1fa2">‚Äì</div>
              <div style="font-size:10px;color:#888">%</div>
            </div>
          </div>

          <!-- Contract Period Summary -->
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px">
            <div style="text-align:center">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Przychody kontraktu</div>
              <div id="eaasTotalRevenue" style="font-size:16px;font-weight:600;color:#1565c0">‚Äì</div>
              <div style="font-size:10px;color:#888">mln PLN</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:11px;color:#666;margin-bottom:4px">OPEX kontraktu</div>
              <div id="eaasTotalOpex" style="font-size:16px;font-weight:600;color:#ff5722">‚Äì</div>
              <div style="font-size:10px;color:#888">mln PLN</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Podatek (CIT)</div>
              <div id="eaasTotalTax" style="font-size:16px;font-weight:600;color:#795548">‚Äì</div>
              <div style="font-size:10px;color:#888">mln PLN</div>
            </div>
            <div style="text-align:center">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Odsetki</div>
              <div id="eaasTotalInterest" style="font-size:16px;font-weight:600;color:#607d8b">‚Äì</div>
              <div style="font-size:10px;color:#888">mln PLN</div>
            </div>
          </div>

          <!-- Model Parameters Info -->
          <div style="margin-top:16px;padding:12px;background:#f5f5f5;border-radius:6px;font-size:11px;color:#666">
            <strong>Parametry modelu:</strong>
            <span id="eaasModelParams">CIT: ‚Äì% | Amortyzacja: ‚Äì lat | Indeksacja: ‚Äì | ≈ªycie projektu: ‚Äì lat</span>
          </div>

          <!-- Residual Value Info -->
          <div style="margin-top:12px;padding:12px;background:#fff8e1;border-radius:6px">
            <div id="eaasResidualValue">
              <div style="font-size:12px;color:#666">
                <span style="font-weight:600">Warto≈õƒá rezydualna:</span> ‚Äì PLN
                <span style="color:#888">(wykup przez klienta)</span>
              </div>
            </div>
          </div>
        </div>

        <button class="btn" onclick="calculateEaaS()" style="width:auto;padding:10px 24px">
          PRZELICZ EaaS
        </button>
        <button class="btn btn-secondary" onclick="exportEaaSToExcel()" style="width:auto;padding:10px 24px;margin-left:12px">
          üì• EKSPORT DO EXCEL
        </button>
        <span style="margin-left:16px;font-size:12px;color:#666">Scenariusz: <strong id="eaasCurrentScenario" style="color:#3f51b5">P50</strong></span>
      </div>

      <div id="eaasResults"></div>

      <!-- EaaS Year-by-Year Table -->
      <div class="table-wrapper" style="margin-top:24px">
        <h3 style="font-size:16px;margin-bottom:12px;color:#2c3e50">Analiza EaaS Rok po Roku z NPV</h3>
        <table id="eaasYearlyTable" class="payback-table">
          <thead>
            <tr>
              <th>Rok</th>
              <th>Deg PV<br/><span class="unit">%</span></th>
              <th>Deg BESS<br/><span class="unit">%</span></th>
              <th>Zu≈ºycie<br/><span class="unit">MWh</span></th>
              <th>Koszt OSD<br/><span class="unit">tys. PLN</span></th>
              <th>Auto PV<br/><span class="unit">MWh</span></th>
              <th>Auto BESS<br/><span class="unit">MWh</span></th>
              <th>Suma Auto<br/><span class="unit">MWh</span></th>
              <th>R√≥wnow. OSD<br/><span class="unit">tys. PLN</span></th>
              <th>Koszt EaaS<br/><span class="unit">tys. PLN</span></th>
              <th>Oszczƒôdn.<br/><span class="unit">tys. PLN</span></th>
              <th>NPV<br/><span class="unit">mln PLN</span></th>
            </tr>
          </thead>
          <tbody id="eaasYearlyTableBody">
            <!-- Wype≈Çnione dynamicznie przez JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Optimization Analysis -->
    <div class="chart-section full-width" id="optimizationSection">
      <h2>üéØ Optymalizacja Wielko≈õci Instalacji</h2>
      <div class="chart-info">
        Por√≥wnanie wariant√≥w pod kƒÖtem NPV vs Autokonsumpcji dla modeli CAPEX i EaaS
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:16px">
        <!-- CAPEX Optimization -->
        <div style="background:#e3f2fd;padding:16px;border-radius:8px;border-left:4px solid #2196f3">
          <h4 style="margin:0 0 12px 0;color:#1565c0;font-size:15px">üí∞ Model CAPEX</h4>
          <div id="capexOptimizationResults">
            <p style="color:#666;font-size:13px">Za≈Çaduj dane aby zobaczyƒá optymalizacjƒô</p>
          </div>
        </div>

        <!-- EaaS Optimization -->
        <div style="background:#fff3e0;padding:16px;border-radius:8px;border-left:4px solid #ff9800">
          <h4 style="margin:0 0 12px 0;color:#e65100;font-size:15px">üìã Model EaaS</h4>
          <div id="eaasOptimizationResults">
            <p style="color:#666;font-size:13px">Za≈Çaduj dane aby zobaczyƒá optymalizacjƒô</p>
          </div>
        </div>
      </div>

      <!-- Comparison Table -->
      <div class="table-wrapper" style="margin-top:20px">
        <h4 style="font-size:14px;margin-bottom:12px;color:#2c3e50">Por√≥wnanie Wariant√≥w</h4>
        <table id="optimizationTable" class="payback-table">
          <thead>
            <tr>
              <th>Wariant</th>
              <th>Moc<br/><span class="unit">kWp</span></th>
              <th>Autokons.<br/><span class="unit">%</span></th>
              <th>NPV CAPEX<br/><span class="unit">mln PLN</span></th>
              <th>IRR CAPEX<br/><span class="unit">%</span></th>
              <th>NPV EaaS<br/><span class="unit">mln PLN</span></th>
              <th>Lepszy<br/><span class="unit">model</span></th>
            </tr>
          </thead>
          <tbody id="optimizationTableBody">
            <!-- Dynamically filled -->
          </tbody>
        </table>
      </div>

      <div style="margin-top:16px;padding:12px;background:#f5f5f5;border-radius:8px;font-size:12px;color:#666">
        <strong>Legenda:</strong>
        üèÜ Najlepszy NPV ‚Ä¢
        ‚ö° Najlepsza autokonsumpcja ‚Ä¢
        üéØ Kompromis (NPV √ó Autokonsumpcja)
      </div>
    </div>

    <!-- Analiza wra≈ºliwo≈õci CAPEX vs EaaS -->
    <div class="chart-section full-width" id="sensitivitySection">
      <h2>üìä Analiza Wra≈ºliwo≈õci: CAPEX vs EaaS</h2>
      <div class="chart-info">
        Por√≥wnanie atrakcyjno≈õci NPV modeli inwestycyjnych przy zmianach kluczowych parametr√≥w
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:16px">
        <!-- Energy Price Sensitivity -->
        <div style="background:#f8f9fa;padding:16px;border-radius:8px">
          <h4 style="margin:0 0 12px 0;color:#2c3e50;font-size:14px">üí° Wp≈Çyw ceny energii na NPV</h4>
          <canvas id="sensitivityEnergyPrice"></canvas>
        </div>

        <!-- Discount Rate Sensitivity -->
        <div style="background:#f8f9fa;padding:16px;border-radius:8px">
          <h4 style="margin:0 0 12px 0;color:#2c3e50;font-size:14px">üìà Wp≈Çyw stopy dyskontowej na NPV</h4>
          <canvas id="sensitivityDiscountRate"></canvas>
        </div>
      </div>

      <!-- Summary table -->
      <div class="table-wrapper" style="margin-top:20px">
        <h4 style="font-size:14px;margin-bottom:12px;color:#2c3e50">Punkty prze≈Çamania (Break-even)</h4>
        <table id="sensitivityBreakevenTable" class="payback-table">
          <thead>
            <tr>
              <th>Parametr</th>
              <th>Warto≈õƒá bazowa</th>
              <th>Break-even<br/><span class="unit">CAPEX = EaaS</span></th>
              <th>Lepszy model<br/><span class="unit">przy bazowych</span></th>
              <th>R√≥≈ºnica NPV<br/><span class="unit">mln PLN</span></th>
            </tr>
          </thead>
          <tbody id="sensitivityBreakevenBody">
            <!-- Dynamically filled -->
          </tbody>
        </table>
      </div>

      <div style="margin-top:16px;padding:12px;background:#e3f2fd;border-radius:8px;font-size:12px;color:#1565c0">
        <strong>Interpretacja:</strong> Wykresy pokazujƒÖ jak zmiana ceny energii lub stopy dyskontowej wp≈Çywa na NPV obu modeli.
        Punkt przeciƒôcia linii to moment, gdy oba modele sƒÖ r√≥wnie atrakcyjne.
      </div>
    </div>

    <!-- Original Sensitivity Analysis (simplified) -->
    <div class="chart-section">
      <h2>Analiza Wra≈ºliwo≈õci (uproszczona)</h2>
      <div class="chart-info">
        Wp≈Çyw zmian parametr√≥w na NPV CAPEX
      </div>
      <canvas id="sensitivityAnalysis"></canvas>
    </div>

    <!-- ============== MONTE CARLO SIMULATION SECTION ============== -->
    <div class="chart-section full-width" id="monteCarloSection">
      <h2>üé≤ Analiza Monte Carlo - Symulacja Ryzyka Finansowego</h2>
      <div class="chart-info">
        Symulacja stochastyczna z uwzglƒôdnieniem niepewno≈õci parametr√≥w i korelacji
      </div>

      <!-- Monte Carlo Configuration -->
      <div style="background:#f8f9fa;border-radius:8px;padding:20px;margin-top:16px;border:1px solid #dee2e6">
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:20px">
          <!-- Number of simulations -->
          <div>
            <label style="font-size:12px;color:#666;display:block;margin-bottom:4px">Liczba symulacji</label>
            <select id="mcSimulations" style="width:100%;padding:8px;border:1px solid #ced4da;border-radius:4px">
              <option value="1000">1,000 (szybka)</option>
              <option value="5000" selected>5,000 (standardowa)</option>
              <option value="10000">10,000 (dok≈Çadna)</option>
              <option value="50000">50,000 (bardzo dok≈Çadna)</option>
            </select>
          </div>

          <!-- Preset -->
          <div>
            <label style="font-size:12px;color:#666;display:block;margin-bottom:4px">Profil ryzyka</label>
            <select id="mcPreset" style="width:100%;padding:8px;border:1px solid #ced4da;border-radius:4px">
              <option value="conservative">Konserwatywny</option>
              <option value="moderate" selected>Umiarkowany</option>
              <option value="optimistic">Optymistyczny</option>
            </select>
          </div>

          <!-- Electricity price uncertainty -->
          <div>
            <label style="font-size:12px;color:#666;display:block;margin-bottom:4px">Niepewno≈õƒá ceny energii [%]</label>
            <input type="number" id="mcPriceUncertainty" value="12" min="0" max="30" step="1"
                   style="width:100%;padding:8px;border:1px solid #ced4da;border-radius:4px"
                   title="Standard bankowy: 12% (FfE, IMF 2024)">
          </div>

          <!-- Production uncertainty -->
          <div>
            <label style="font-size:12px;color:#666;display:block;margin-bottom:4px">Niepewno≈õƒá produkcji [%]</label>
            <input type="number" id="mcProductionUncertainty" value="8" min="0" max="20" step="1"
                   style="width:100%;padding:8px;border:1px solid #ced4da;border-radius:4px"
                   title="Standard NREL P50/P90: 8%">
          </div>
        </div>

        <div style="display:flex;gap:12px;align-items:center">
          <button class="btn" onclick="runMonteCarlo()" id="mcRunButton">
            üé≤ URUCHOM SYMULACJƒò MONTE CARLO
          </button>
          <span id="mcStatus" style="font-size:13px;color:#666"></span>
        </div>
      </div>

      <!-- Monte Carlo Results (hidden until simulation runs) -->
      <div id="mcResults" style="display:none;margin-top:24px">

        <!-- BASE SCENARIO PARAMETERS PANEL -->
        <div style="background:#fff;border:2px solid #1565c0;border-radius:8px;padding:16px;margin-bottom:24px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
            <h4 style="margin:0;font-size:14px;color:#1565c0">üìã Parametry Scenariusza Bazowego (punkt startowy analizy)</h4>
            <button class="btn" onclick="exportMonteCarloToExcel()" style="background:#27ae60;font-size:12px;padding:8px 16px">
              üìä EKSPORT DO EXCEL
            </button>
          </div>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px">
            <!-- Variant data -->
            <div style="background:#e3f2fd;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Moc instalacji</div>
              <div id="mcBaseCapacity" style="font-size:16px;font-weight:600;color:#1565c0">-</div>
              <div style="font-size:10px;color:#888">kWp</div>
            </div>
            <div style="background:#e3f2fd;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Roczna produkcja</div>
              <div id="mcBaseProduction" style="font-size:16px;font-weight:600;color:#1565c0">-</div>
              <div style="font-size:10px;color:#888">MWh/rok</div>
            </div>
            <div style="background:#e3f2fd;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Autokonsumpcja</div>
              <div id="mcBaseSelfConsumed" style="font-size:16px;font-weight:600;color:#1565c0">-</div>
              <div style="font-size:10px;color:#888">MWh/rok</div>
            </div>
            <div style="background:#e3f2fd;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Autokonsumpcja %</div>
              <div id="mcBaseAutoPct" style="font-size:16px;font-weight:600;color:#1565c0">-</div>
              <div style="font-size:10px;color:#888">%</div>
            </div>
            <!-- Economic parameters -->
            <div style="background:#fff3e0;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Cena energii (z op≈Ç. moc.)</div>
              <div id="mcBaseEnergyPrice" style="font-size:16px;font-weight:600;color:#e65100">-</div>
              <div style="font-size:10px;color:#888">PLN/MWh</div>
            </div>
            <div style="background:#fff3e0;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">CAPEX jednostkowy</div>
              <div id="mcBaseCapex" style="font-size:16px;font-weight:600;color:#e65100">-</div>
              <div style="font-size:10px;color:#888">PLN/kWp</div>
            </div>
            <div style="background:#fff3e0;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">CAPEX ca≈Çkowity</div>
              <div id="mcBaseTotalCapex" style="font-size:16px;font-weight:600;color:#e65100">-</div>
              <div style="font-size:10px;color:#888">mln PLN</div>
            </div>
            <div style="background:#fff3e0;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Stopa dyskontowa</div>
              <div id="mcBaseDiscount" style="font-size:16px;font-weight:600;color:#e65100">-</div>
              <div style="font-size:10px;color:#888">%</div>
            </div>
            <!-- Additional params -->
            <div style="background:#f5f5f5;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">OPEX</div>
              <div id="mcBaseOpex" style="font-size:16px;font-weight:600;color:#555">-</div>
              <div style="font-size:10px;color:#888">PLN/kWp/rok</div>
            </div>
            <div style="background:#f5f5f5;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Degradacja</div>
              <div id="mcBaseDegradation" style="font-size:16px;font-weight:600;color:#555">-</div>
              <div style="font-size:10px;color:#888">%/rok</div>
            </div>
            <div style="background:#f5f5f5;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Okres analizy</div>
              <div id="mcBasePeriod" style="font-size:16px;font-weight:600;color:#555">-</div>
              <div style="font-size:10px;color:#888">lat</div>
            </div>
            <div style="background:#f5f5f5;padding:12px;border-radius:6px">
              <div style="font-size:11px;color:#666;margin-bottom:4px">Inflacja</div>
              <div id="mcBaseInflation" style="font-size:16px;font-weight:600;color:#555">-</div>
              <div style="font-size:10px;color:#888">%</div>
            </div>
          </div>
        </div>

        <!-- Key Risk Metrics -->
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:16px;margin-bottom:24px">
          <div style="background:#e8f5e9;padding:16px;border-radius:8px;text-align:center">
            <div style="font-size:11px;color:#666;margin-bottom:4px">Prawdopodobie≈Ñstwo zysku</div>
            <div id="mcProbPositive" style="font-size:28px;font-weight:700;color:#2e7d32">-</div>
            <div style="font-size:11px;color:#888">%</div>
          </div>
          <div style="background:#e3f2fd;padding:16px;border-radius:8px;text-align:center">
            <div style="font-size:11px;color:#666;margin-bottom:4px">NPV Mediana (P50)</div>
            <div id="mcNpvMedian" style="font-size:22px;font-weight:700;color:#1565c0">-</div>
            <div style="font-size:11px;color:#888">mln PLN</div>
          </div>
          <div style="background:#fff3e0;padding:16px;border-radius:8px;text-align:center">
            <div style="font-size:11px;color:#666;margin-bottom:4px">NPV Pesymistyczny (P10)</div>
            <div id="mcNpvP10" style="font-size:22px;font-weight:700;color:#e65100">-</div>
            <div style="font-size:11px;color:#888">mln PLN</div>
          </div>
          <div style="background:#e8eaf6;padding:16px;border-radius:8px;text-align:center">
            <div style="font-size:11px;color:#666;margin-bottom:4px">NPV Optymistyczny (P90)</div>
            <div id="mcNpvP90" style="font-size:22px;font-weight:700;color:#3f51b5">-</div>
            <div style="font-size:11px;color:#888">mln PLN</div>
          </div>
          <div style="background:#fce4ec;padding:16px;border-radius:8px;text-align:center">
            <div style="font-size:11px;color:#666;margin-bottom:4px">VaR 95%</div>
            <div id="mcVar95" style="font-size:22px;font-weight:700;color:#c2185b">-</div>
            <div style="font-size:11px;color:#888">mln PLN</div>
          </div>
        </div>

        <!-- NPV Histogram Chart -->
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin-bottom:24px">
          <div style="background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:16px">
            <h4 style="margin:0 0 12px 0;font-size:14px;color:#2c3e50">Rozk≈Çad NPV (Histogram)</h4>
            <canvas id="mcNpvHistogram" style="max-height:300px"></canvas>
          </div>

          <!-- IRR and Payback Stats -->
          <div style="background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:16px">
            <h4 style="margin:0 0 16px 0;font-size:14px;color:#2c3e50">Statystyki IRR i Payback</h4>

            <div style="margin-bottom:20px">
              <div style="font-size:12px;color:#666;margin-bottom:8px">IRR</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center">
                <div style="background:#f5f5f5;padding:8px;border-radius:4px">
                  <div style="font-size:10px;color:#888">P10</div>
                  <div id="mcIrrP10" style="font-size:16px;font-weight:600;color:#e65100">-</div>
                </div>
                <div style="background:#e8f5e9;padding:8px;border-radius:4px">
                  <div style="font-size:10px;color:#888">Mediana</div>
                  <div id="mcIrrMedian" style="font-size:16px;font-weight:600;color:#2e7d32">-</div>
                </div>
                <div style="background:#f5f5f5;padding:8px;border-radius:4px">
                  <div style="font-size:10px;color:#888">P90</div>
                  <div id="mcIrrP90" style="font-size:16px;font-weight:600;color:#3f51b5">-</div>
                </div>
              </div>
            </div>

            <div style="margin-bottom:20px">
              <div style="font-size:12px;color:#666;margin-bottom:8px">Okres zwrotu (lat)</div>
              <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;text-align:center">
                <div style="background:#e8f5e9;padding:8px;border-radius:4px">
                  <div style="font-size:10px;color:#888">P10 (najlepszy)</div>
                  <div id="mcPaybackP10" style="font-size:16px;font-weight:600;color:#2e7d32">-</div>
                </div>
                <div style="background:#f5f5f5;padding:8px;border-radius:4px">
                  <div style="font-size:10px;color:#888">Mediana</div>
                  <div id="mcPaybackMedian" style="font-size:16px;font-weight:600;color:#2c3e50">-</div>
                </div>
                <div style="background:#fff3e0;padding:8px;border-radius:4px">
                  <div style="font-size:10px;color:#888">P90 (najgorszy)</div>
                  <div id="mcPaybackP90" style="font-size:16px;font-weight:600;color:#e65100">-</div>
                </div>
              </div>
            </div>

            <!-- Computation info -->
            <div style="font-size:11px;color:#888;border-top:1px solid #eee;padding-top:12px">
              <div>Symulacji: <span id="mcSimCount">-</span></div>
              <div>Czas oblicze≈Ñ: <span id="mcCompTime">-</span> ms</div>
            </div>
          </div>
        </div>

        <!-- Insights -->
        <div style="background:#e3f2fd;border-radius:8px;padding:16px;margin-bottom:24px">
          <h4 style="margin:0 0 12px 0;font-size:14px;color:#1565c0">üí° Wnioski z analizy</h4>
          <ul id="mcInsights" style="margin:0;padding-left:20px;font-size:13px;line-height:1.8;color:#1565c0">
            <li>Uruchom symulacjƒô aby zobaczyƒá wnioski</li>
          </ul>
        </div>

        <!-- Scenario Comparison -->
        <div style="background:#fff;border:1px solid #dee2e6;border-radius:8px;padding:16px">
          <h4 style="margin:0 0 16px 0;font-size:14px;color:#2c3e50">Por√≥wnanie scenariuszy</h4>
          <table class="payback-table" style="margin:0">
            <thead>
              <tr>
                <th>Scenariusz</th>
                <th>NPV<br/><span class="unit">mln PLN</span></th>
                <th>IRR<br/><span class="unit">%</span></th>
                <th>Payback<br/><span class="unit">lat</span></th>
                <th>Interpretacja</th>
              </tr>
            </thead>
            <tbody>
              <tr style="background:#fff3e0">
                <td><strong>Pesymistyczny (P10)</strong></td>
                <td id="mcScenP10Npv">-</td>
                <td id="mcScenP10Irr">-</td>
                <td id="mcScenP10Payback">-</td>
                <td style="font-size:12px">10% scenariuszy jest gorszych</td>
              </tr>
              <tr style="background:#e8f5e9">
                <td><strong>Bazowy (Mediana)</strong></td>
                <td id="mcScenBaseNpv">-</td>
                <td id="mcScenBaseIrr">-</td>
                <td id="mcScenBasePayback">-</td>
                <td style="font-size:12px">Najbardziej prawdopodobny wynik</td>
              </tr>
              <tr style="background:#e8eaf6">
                <td><strong>Optymistyczny (P90)</strong></td>
                <td id="mcScenP90Npv">-</td>
                <td id="mcScenP90Irr">-</td>
                <td id="mcScenP90Payback">-</td>
                <td style="font-size:12px">90% scenariuszy jest gorszych</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- No data message -->
      <div id="mcNoData" style="text-align:center;padding:40px;color:#666">
        <div style="font-size:48px;margin-bottom:16px">üé≤</div>
        <p>Wykonaj analizƒô ekonomicznƒÖ (modu≈Ç Konfiguracja), a nastƒôpnie uruchom symulacjƒô Monte Carlo.</p>
      </div>
    </div>

    <!-- BESS Analysis Section - MOVED TO DEDICATED BESS MODULE -->
    <!-- Sekcja BESS przeniesiona do dedykowanego modu≈Çu BESS w menu g≈Ç√≥wnym -->

    <!-- Szczeg√≥≈Çowe wska≈∫niki -->
    <div class="details-section full-width">
      <h2>Szczeg√≥≈Çowe Wska≈∫niki Finansowe</h2>
      <div class="details-grid">
        <div class="detail-item">
          <span class="detail-label">CAPEX Jednostkowy:</span>
          <span class="detail-value" id="unitCapex">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">LCOE:</span>
          <span class="detail-value" id="lcoe">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">OPEX Roczny:</span>
          <span class="detail-value" id="opexAnnual">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Przych√≥d Roczny:</span>
          <span class="detail-value" id="revenueAnnual">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Oszczƒôdno≈õci Roczne:</span>
          <span class="detail-value" id="savingsAnnual">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">ROI:</span>
          <span class="detail-value" id="roi">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Stopa Dyskontowa:</span>
          <span class="detail-value" id="discountRate">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Okres Analizy:</span>
          <span class="detail-value" id="analysisHorizon">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Cena Energii:</span>
          <span class="detail-value" id="energyPrice">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Dotacje:</span>
          <span class="detail-value" id="subsidies">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Podatek:</span>
          <span class="detail-value" id="taxRate">-</span>
        </div>
        <div class="detail-item">
          <span class="detail-label">Inflacja:</span>
          <span class="detail-value" id="inflationRate">-</span>
        </div>
      </div>
    </div>

    <!-- Tabela zwrotu inwestycji CAPEX -->
    <div class="table-section full-width">
      <h2>Analiza CAPEX Rok po Roku z NPV</h2>
      <div class="chart-info">
        Szczeg√≥≈Çowy przebieg cash flow z uwzglƒôdnieniem degradacji i inflacji
      </div>
      <div class="table-wrapper">
        <table id="paybackTable" class="payback-table">
          <thead>
            <tr>
              <th>Rok</th>
              <th>Deg PV<br/><span class="unit">%</span></th>
              <th>Deg BESS<br/><span class="unit">%</span></th>
              <th>Zu≈ºycie<br/><span class="unit">MWh</span></th>
              <th>Koszt OSD<br/><span class="unit">tys. PLN</span></th>
              <th>Auto PV<br/><span class="unit">MWh</span></th>
              <th>Auto BESS<br/><span class="unit">MWh</span></th>
              <th>Suma Auto<br/><span class="unit">MWh</span></th>
              <th>R√≥wnow. OSD<br/><span class="unit">tys. PLN</span></th>
              <th>OPEX<br/><span class="unit">tys. PLN</span></th>
              <th>Oszczƒôdn.<br/><span class="unit">tys. PLN</span></th>
              <th>NPV<br/><span class="unit">mln PLN</span></th>
            </tr>
          </thead>
          <tbody id="paybackTableBody">
            <!-- Wype≈Çnione dynamicznie przez JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Akcje -->
    <div class="actions-section full-width">
      <button class="btn" onclick="exportEconomics()">Eksportuj Analizƒô</button>
    </div>
    </div>

    <!-- Info gdy brak danych -->
    <div id="noDataMessage" class="no-data">
      <div class="no-data-icon">üí∞</div>
      <h3>Brak Danych Ekonomicznych</h3>
      <p>Wykonaj analizƒô w module Configuration i przejd≈∫ tutaj aby zobaczyƒá wyniki ekonomiczne.</p>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="economics.js?v=20251224-MONTE-CARLO"></script>
<script src="monte-carlo.js?v=20251224"></script>
</body>
</html>
