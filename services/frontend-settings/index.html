<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ustawienia Systemu</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="settings-container">
  <div class="settings-header">
    <h1>âš™ï¸ USTAWIENIA SYSTEMU</h1>
    <p>Centralna konfiguracja wszystkich parametrÃ³w analizy PV</p>
  </div>

  <div class="settings-content">
    <!-- Energy Tariff Section -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸ’¡</span>
        <h2>Taryfa Energetyczna</h2>
        <span class="section-info">SkÅ‚adniki ceny energii [PLN/MWh]</span>
      </div>
      <div class="settings-grid">
        <div class="setting-item">
          <label>Energia czynna</label>
          <input type="number" id="energyActive" value="550" step="10">
          <span class="setting-hint">Podstawowa stawka za energiÄ™</span>
        </div>
        <div class="setting-item">
          <label>Dystrybucja</label>
          <input type="number" id="distribution" value="200" step="10">
          <span class="setting-hint">OpÅ‚ata dystrybucyjna</span>
        </div>
        <div class="setting-item">
          <label>OpÅ‚ata jakoÅ›ciowa</label>
          <input type="number" id="qualityFee" value="10" step="1">
          <span class="setting-hint">Za jakoÅ›Ä‡ energii</span>
        </div>
        <div class="setting-item">
          <label>OpÅ‚ata OZE</label>
          <input type="number" id="ozeFee" value="7" step="1">
          <span class="setting-hint">Wsparcie OZE</span>
        </div>
        <div class="setting-item">
          <label>OpÅ‚ata kogeneracyjna</label>
          <input type="number" id="cogenerationFee" value="10" step="1">
          <span class="setting-hint">Wsparcie kogeneracji</span>
        </div>
        <div class="setting-item">
          <label>OpÅ‚ata mocowa (7-21)</label>
          <input type="number" id="capacityFee" value="219" step="10">
          <span class="setting-hint">Godziny szczytu</span>
        </div>
        <div class="setting-item">
          <label>Akcyza</label>
          <input type="number" id="exciseTax" value="5" step="1">
          <span class="setting-hint">Podatek akcyzowy</span>
        </div>
        <div class="setting-item highlight">
          <label>SUMA</label>
          <input type="number" id="totalEnergyPrice" value="1001" readonly>
          <span class="setting-hint">CaÅ‚kowita cena energii</span>
        </div>
      </div>
    </div>

    <!-- CAPEX Tiers Section - Per Installation Type -->
    <div class="settings-section" style="grid-column: span 2;">
      <div class="section-header">
        <span class="section-icon">ğŸ’°</span>
        <h2>PrzedziaÅ‚y CAPEX wg typu instalacji</h2>
        <span class="section-info">Koszt, marÅ¼a i cena sprzedaÅ¼y [PLN/kWp]</span>
      </div>

      <div style="margin-bottom:16px;padding:12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
        <div style="font-size:12px;color:#1565c0">
          <strong>ğŸ’¡ ObjaÅ›nienia:</strong><br>
          <strong>Koszt/kWp</strong> - koszt zakupu i instalacji dla danego przedziaÅ‚u mocy<br>
          <strong>MarÅ¼a [%]</strong> - marÅ¼a handlowa (krok 0.1%, np. 17.0%, 17.5%, 18.3%)<br>
          <strong>SprzedaÅ¼/kWp</strong> - cena sprzedaÅ¼y = Koszt / (1 - MarÅ¼a/100)<br>
          <em>PrzykÅ‚ad: Koszt 2000 PLN, MarÅ¼a 20% â†’ 2000 / 0.80 = 2500 PLN</em>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="capex-tabs" style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
        <button class="capex-tab active" onclick="showCapexTab('ground_s')" id="tab_ground_s" style="padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;background:#4caf50;color:white">
          ğŸŒ Grunt PoÅ‚udnie
        </button>
        <button class="capex-tab" onclick="showCapexTab('ground_ew')" id="tab_ground_ew" style="padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;background:#f5f5f5;color:#666">
          ğŸŒ Grunt E-W
        </button>
        <button class="capex-tab" onclick="showCapexTab('roof_ew')" id="tab_roof_ew" style="padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;background:#f5f5f5;color:#666">
          ğŸ  Dach E-W
        </button>
        <button class="capex-tab" onclick="showCapexTab('carport')" id="tab_carport" style="padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;background:#f5f5f5;color:#666">
          ğŸš— Carport
        </button>
      </div>

      <!-- Dynamiczne panele CAPEX per typ - renderowane przez JavaScript -->
      <div id="capex_ground_s" class="capex-panel" style="display:block"></div>
      <div id="capex_ground_ew" class="capex-panel" style="display:none"></div>
      <div id="capex_roof_ew" class="capex-panel" style="display:none"></div>
      <div id="capex_carport" class="capex-panel" style="display:none"></div>

    </div>

    <!-- OPEX Section -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸ”§</span>
        <h2>Koszty Operacyjne (OPEX)</h2>
        <span class="section-info">Roczne koszty eksploatacji</span>
      </div>
      <div class="settings-grid">
        <div class="setting-item">
          <label>OPEX [PLN/kWp/rok]</label>
          <input type="number" id="opexPerKwp" value="15" step="1">
          <span class="setting-hint">Koszty serwisu i utrzymania</span>
        </div>
        <div class="setting-item">
          <label>O&M EaaS [PLN/kWp/rok]</label>
          <input type="number" id="eaasOM" value="24" step="1">
          <span class="setting-hint">Koszty O&M w modelu EaaS</span>
        </div>
        <div class="setting-item">
          <label>Ubezpieczenie [% CAPEX/rok]</label>
          <input type="number" id="insuranceRate" value="0.3" step="0.1" min="0" max="2">
          <span class="setting-hint">Stawka ubezpieczenia</span>
        </div>
        <div class="setting-item">
          <label>Najem powierzchni [PLN/kWp/rok]</label>
          <input type="number" id="landLeasePerKwp" value="0" step="1" min="0">
          <span class="setting-hint">Koszt dzierÅ¼awy gruntu</span>
        </div>
      </div>
    </div>

    <!-- Financial Parameters Section -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸ“Š</span>
        <h2>Parametry Finansowe</h2>
        <span class="section-info">Stopy, okresy i wskaÅºniki</span>
      </div>
      <div class="settings-grid">
        <div class="setting-item">
          <label>Stopa dyskontowa [%]</label>
          <input type="number" id="discountRate" value="7" step="0.5" min="0" max="20">
          <span class="setting-hint">Do obliczenia NPV</span>
        </div>
        <div class="setting-item">
          <label>Degradacja PV rok 1 [%]</label>
          <input type="number" id="pvDegradationYear1" value="2.0" step="0.1" min="0" max="5">
          <span class="setting-hint">Pierwszy rok (wyÅ¼sza)</span>
        </div>
        <div class="setting-item">
          <label>Degradacja PV lata 2+ [%/rok]</label>
          <input type="number" id="degradationRate" value="0.5" step="0.1" min="0" max="2">
          <span class="setting-hint">PozostaÅ‚e lata</span>
        </div>
        <div class="setting-item">
          <label>Okres analizy [lat]</label>
          <input type="number" id="analysisPeriod" value="25" step="1" min="10" max="30">
          <span class="setting-hint">Horyzont czasowy</span>
        </div>
        <div class="setting-item">
          <label>Inflacja [%/rok]</label>
          <input type="number" id="inflationRate" value="2.5" step="0.5" min="0" max="10">
          <span class="setting-hint">Wzrost cen energii</span>
        </div>
      </div>

      <!-- IRR Calculation Mode -->
      <div style="margin-top:20px;padding:16px;background:#fff8e1;border-radius:8px;border-left:4px solid #ffc107">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <input type="checkbox" id="useInflation" style="width:20px;height:20px;cursor:pointer">
          <label for="useInflation" style="font-weight:600;color:#f57c00;cursor:pointer;margin:0">
            UwzglÄ™dniaj inflacjÄ™ w obliczeniu IRR (tryb nominalny)
          </label>
        </div>
        <div style="font-size:12px;color:#795548;margin-left:32px">
          <strong>WyÅ‚Ä…czone (domyÅ›lnie):</strong> IRR realny - staÅ‚e ceny energii i OPEX przez caÅ‚y okres analizy<br>
          <strong>WÅ‚Ä…czone:</strong> IRR nominalny - ceny energii, OPEX i taryfy feed-in indeksowane o inflacjÄ™ rocznie
        </div>
      </div>
    </div>

    <!-- EaaS Parameters Section (Password Protected) -->
    <div class="settings-section" id="eaasPasswordSection">
      <div class="section-header">
        <span class="section-icon">ğŸ”’</span>
        <h2>Parametry EaaS (Energy-as-a-Service)</h2>
        <span class="section-info">Sekcja chroniona hasÅ‚em</span>
      </div>
      <div style="text-align:center;padding:40px">
        <button onclick="unlockEaasSection()" style="padding:12px 24px;background:#4caf50;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;font-weight:600">
          ğŸ”“ PokaÅ¼ parametry EaaS
        </button>
      </div>
    </div>

    <!-- EaaS Parameters Section (Hidden by default) -->
    <div class="settings-section" id="eaasParamsSection" style="display:none">
      <div class="section-header">
        <span class="section-icon">ğŸ“‹</span>
        <h2>Parametry EaaS (Energy-as-a-Service)</h2>
        <span class="section-info">PeÅ‚ny model inwestorski - kalkulacja abonamentu na podstawie docelowego IRR</span>
      </div>

      <div style="margin-bottom:20px;padding:16px;background:#e8f5e9;border-radius:8px;border-left:4px solid #4caf50">
        <div style="font-size:13px;font-weight:600;color:#2e7d32;margin-bottom:8px">ğŸ’¡ Jak dziaÅ‚a kalkulacja EaaS?</div>
        <div style="font-size:12px;color:#1b5e20;line-height:1.6">
          Model oblicza miesiÄ™czny abonament EaaS aby zapewniÄ‡ ESCO docelowÄ… stopÄ™ zwrotu (IRR).<br>
          <strong>UwzglÄ™dnia:</strong> CAPEX, OPEX, podatki, amortyzacjÄ™, finansowanie dÅ‚uÅ¼ne, degradacjÄ™ i indeksacjÄ™ CPI.<br>
          <strong>Wynik:</strong> Project IRR (przed dÅ‚ugiem) i Equity IRR (po dÅ‚ugu) + szczegÃ³Å‚owe przepÅ‚ywy miesiÄ™czne.
        </div>
      </div>

      <!-- Subsection: Contract Basics -->
      <div style="margin-bottom:20px;padding:15px;background:#f5f5f5;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #4caf50;padding-bottom:6px">
          ğŸ“ Podstawowe parametry kontraktu
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Waluta kontraktu</label>
            <select id="eaasCurrency" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="PLN">PLN (ZÅ‚oty Polski)</option>
              <option value="EUR">EUR (Euro)</option>
            </select>
            <span class="setting-hint">Waluta rozliczeÅ„ EaaS</span>
          </div>

          <div class="setting-item">
            <label>IRR Driver</label>
            <select id="irrDriver" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="PLN">PLN - optymalizuj IRR w PLN</option>
              <option value="EUR">EUR - optymalizuj IRR w EUR</option>
            </select>
            <span class="setting-hint">Waluta do optymalizacji IRR</span>
          </div>

          <div class="setting-item">
            <label>Okres umowy EaaS [lat]</label>
            <input type="number" id="eaasDuration" value="10" step="1" min="5" max="25">
            <span class="setting-hint">DÅ‚ugoÅ›Ä‡ kontraktu subskrypcyjnego</span>
          </div>

          <div class="setting-item">
            <label>Okres Å¼ycia projektu [lat]</label>
            <input type="number" id="projectLifetime" value="25" step="1" min="15" max="35">
            <span class="setting-hint">CaÅ‚kowity okres eksploatacji PV</span>
          </div>

          <div class="setting-item">
            <label>Typ abonamentu</label>
            <select id="eaasIndexation" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="fixed">Fixed (staÅ‚a rata nominalna)</option>
              <option value="cpi">CPI (indeksacja inflacjÄ…)</option>
            </select>
            <span class="setting-hint">Czy abonament roÅ›nie z inflacjÄ…</span>
          </div>

          <div class="setting-item">
            <label>Docelowe IRR - PLN [%]</label>
            <input type="number" id="eaasTargetIrrPln" value="12.0" step="0.5" min="5" max="30">
            <span class="setting-hint">Target IRR dla kontraktÃ³w PLN</span>
          </div>

          <div class="setting-item">
            <label>Docelowe IRR - EUR [%]</label>
            <input type="number" id="eaasTargetIrrEur" value="10.0" step="0.5" min="5" max="25">
            <span class="setting-hint">Target IRR dla kontraktÃ³w EUR</span>
          </div>

          <div class="setting-item">
            <label>Kurs PLN/EUR</label>
            <input type="number" id="fxPlnEur" value="4.5" step="0.01" min="3" max="6">
            <span class="setting-hint">Kurs wymiany walut</span>
          </div>
        </div>
      </div>

      <!-- Subsection: Tax & Depreciation -->
      <div style="margin-bottom:20px;padding:15px;background:#fff8e1;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #ffc107;padding-bottom:6px">
          ğŸ›ï¸ Podatki i amortyzacja
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Stawka CIT [%]</label>
            <input type="number" id="citRate" value="19.0" step="1" min="0" max="40">
            <span class="setting-hint">Podatek dochodowy CIT (19% w PL)</span>
          </div>

          <div class="setting-item">
            <label>Metoda amortyzacji</label>
            <select id="depreciationMethod" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="linear">Liniowa</option>
              <option value="degressive">Degresywna</option>
            </select>
            <span class="setting-hint">SposÃ³b naliczania amortyzacji</span>
          </div>

          <div class="setting-item">
            <label>Okres amortyzacji [lat]</label>
            <input type="number" id="depreciationPeriod" value="20" step="1" min="5" max="30">
            <span class="setting-hint">Roczna amortyzacja = CAPEX / okres</span>
          </div>
        </div>
      </div>

      <!-- Subsection: Financing -->
      <div style="margin-bottom:20px;padding:15px;background:#e3f2fd;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #2196f3;padding-bottom:6px">
          ğŸ¦ Finansowanie (dÅ‚ug)
        </div>
        <div style="margin-bottom:12px;padding:10px;background:#bbdefb;border-radius:6px;font-size:12px;color:#1565c0">
          <strong>ğŸ’¡ Uwaga:</strong> Leverage = 0% oznacza finansowanie 100% z equity. ZwiÄ™kszenie leverage zmniejsza Equity IRR ale zwiÄ™ksza ROE.
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Leverage [%]</label>
            <input type="number" id="leverageRatio" value="0" step="5" min="0" max="80">
            <span class="setting-hint">% CAPEX finansowany dÅ‚ugiem (0-80%)</span>
          </div>

          <div class="setting-item">
            <label>Koszt dÅ‚ugu [%/rok]</label>
            <input type="number" id="costOfDebt" value="7.0" step="0.25" min="2" max="15">
            <span class="setting-hint">Nominalna stopa procentowa</span>
          </div>

          <div class="setting-item">
            <label>Okres kredytu [lat]</label>
            <input type="number" id="debtTenor" value="8" step="1" min="3" max="20">
            <span class="setting-hint">Tenor kredytu</span>
          </div>

          <div class="setting-item">
            <label>Karencja [lat]</label>
            <input type="number" id="debtGracePeriod" value="0" step="1" min="0" max="3">
            <span class="setting-hint">Okres spÅ‚aty tylko odsetek</span>
          </div>

          <div class="setting-item">
            <label>Typ spÅ‚aty</label>
            <select id="debtAmortization" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="annuity">Annuitetowa (rÃ³wne raty)</option>
              <option value="linear">Liniowa (malejÄ…ce raty)</option>
            </select>
            <span class="setting-hint">Profil spÅ‚aty kapitaÅ‚u</span>
          </div>
        </div>
      </div>

      <!-- Subsection: CPI Indexation -->
      <div style="margin-bottom:20px;padding:15px;background:#fce4ec;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #e91e63;padding-bottom:6px">
          ğŸ“ˆ Indeksacja CPI
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>CPI PLN [%/rok]</label>
            <input type="number" id="cpiPln" value="2.5" step="0.1" min="0" max="15">
            <span class="setting-hint">ZaÅ‚oÅ¼ona inflacja PLN</span>
          </div>

          <div class="setting-item">
            <label>CPI EUR [%/rok]</label>
            <input type="number" id="cpiEur" value="2.0" step="0.1" min="0" max="10">
            <span class="setting-hint">ZaÅ‚oÅ¼ona inflacja EUR</span>
          </div>

          <div class="setting-item">
            <label>CzÄ™stotliwoÅ›Ä‡</label>
            <select id="indexationFrequency" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="annual">Roczna</option>
              <option value="quarterly">Kwartalna</option>
            </select>
            <span class="setting-hint">Jak czÄ™sto indeksowaÄ‡</span>
          </div>

          <div class="setting-item">
            <label>CPI Floor [%]</label>
            <input type="number" id="cpiFloor" value="0" step="0.5" min="-5" max="5">
            <span class="setting-hint">Minimalna indeksacja (np. 0%)</span>
          </div>

          <div class="setting-item">
            <label>CPI Cap roczny [%]</label>
            <input type="number" id="cpiCapAnnual" value="5.0" step="0.5" min="0" max="20">
            <span class="setting-hint">Max indeksacja w jednym roku</span>
          </div>

          <div class="setting-item">
            <label>CPI Cap caÅ‚kowity [%]</label>
            <input type="number" id="cpiCapTotal" value="50.0" step="5" min="0" max="100">
            <span class="setting-hint">Max skumulowana indeksacja</span>
          </div>
        </div>
      </div>

      <!-- Subsection: Technical & Risk -->
      <div style="margin-bottom:20px;padding:15px;background:#f3e5f5;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #9c27b0;padding-bottom:6px">
          âš™ï¸ Parametry techniczne i ryzyko
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>DostÄ™pnoÅ›Ä‡ instalacji [%]</label>
            <input type="number" id="availabilityFactor" value="98.0" step="0.5" min="90" max="100">
            <span class="setting-hint">UwzglÄ™dnia awarie i przestoje</span>
          </div>

          <div class="setting-item">
            <label>Margines 0-export [%]</label>
            <input type="number" id="zeroExportMargin" value="0" step="1" min="0" max="20">
            <span class="setting-hint">Bezpiecznik przed przekroczeniem</span>
          </div>

          <div class="setting-item">
            <label>Expected Loss Rate [%]</label>
            <input type="number" id="expectedLossRate" value="0" step="0.5" min="0" max="10">
            <span class="setting-hint">Ryzyko kredytowe klienta</span>
          </div>
        </div>
      </div>

      <div style="padding:12px;background:#e8f5e9;border-radius:8px;border-left:3px solid #4caf50">
        <div style="font-size:12px;color:#2e7d32">
          <strong>ğŸ“Š Model generuje:</strong><br>
          â€¢ MiesiÄ™czne przepÅ‚ywy pieniÄ™Å¼ne (CF) przez caÅ‚y okres projektu<br>
          â€¢ Project IRR (przed finansowaniem) i Equity IRR (po finansowaniu)<br>
          â€¢ EBITDA, EBIT, podatek CIT z tarczÄ… amortyzacyjnÄ…<br>
          â€¢ ObsÅ‚ugÄ™ dÅ‚ugu (odsetki + kapitaÅ‚) jeÅ›li leverage > 0<br>
          â€¢ WartoÅ›Ä‡ rezydualnÄ… po zakoÅ„czeniu kontraktu<br>
          â€¢ CenÄ™ EaaS per MWh i porÃ³wnanie do ceny z sieci
        </div>
      </div>
    </div>

    <!-- Weather Data Source & Production Scenarios -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸŒ¤ï¸</span>
        <h2>Å¹rÃ³dÅ‚o Danych Meteorologicznych</h2>
        <span class="section-info">Dane pogodowe i scenariusze produkcji PV</span>
      </div>

      <div class="setting-item" style="max-width:600px;margin-bottom:20px">
        <label>Å¹rÃ³dÅ‚o danych pogodowych</label>
        <select id="weatherDataSource" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
          <option value="pvgis">PVGIS (Rekomendowane) - Dane TMY z EU</option>
          <option value="clearsky">Clearsky Model - Symulacja bezchmurnego nieba</option>
        </select>
        <span class="setting-hint">PVGIS: Rzeczywiste dane meteorologiczne dla Europy (dokÅ‚adniejsze). Clearsky: Model teoretyczny (szybszy, mniej dokÅ‚adny)</span>
      </div>

      <!-- Production Scenarios (P-factors) -->
      <div style="margin-top:24px;padding:20px;background:#e8eaf6;border-radius:8px;border-left:4px solid #3f51b5">
        <div style="font-weight:600;color:#1a237e;margin-bottom:12px;font-size:15px">
          ğŸ“Š Scenariusze produkcji (P-factors)
        </div>
        <div style="margin-bottom:16px;padding:12px;background:#c5cae9;border-radius:6px;font-size:12px;color:#283593;line-height:1.5">
          Scenariusze P50/P75/P90 sÅ‚uÅ¼Ä… do modelowania niepewnoÅ›ci produkcji energii.<br>
          <strong>P50</strong> = scenariusz bazowy (mediana), <strong>P75</strong> i <strong>P90</strong> = coraz bardziej ostroÅ¼ne warianty â€“ z odpowiednio 25% i 10% szansÄ… na niÅ¼szÄ… produkcjÄ™.
        </div>

        <!-- Source Selection -->
        <div class="setting-item" style="margin-bottom:16px">
          <label style="font-weight:600;color:#3f51b5">Å¹rÃ³dÅ‚o mnoÅ¼nikÃ³w Pxx</label>
          <select id="pxxSource" onchange="togglePxxSourceFields()" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
            <option value="manual">Manualne (staÅ‚e wartoÅ›ci 100/97/94%)</option>
            <option value="pvgis_uncertainty">PVGIS Uncertainty (szybkie - PVcalc)</option>
            <option value="pvgis_timeseries">PVGIS Timeseries (dokÅ‚adne - seriescalc)</option>
          </select>
        </div>

        <!-- Method descriptions -->
        <div id="pxxMethodDescription" style="margin-bottom:16px;padding:10px;background:#fff;border-radius:6px;font-size:11px;color:#555;line-height:1.5">
          <strong>PVGIS Uncertainty (szybkie)</strong> - Liczy P50/P75/P90 na podstawie Å›redniej rocznej produkcji i niepewnoÅ›ci modelu PVGIS. Idealne do codziennych symulacji.<br>
          <strong>PVGIS Timeseries (dokÅ‚adne)</strong> - Pobiera wieloletniÄ… seriÄ™ godzinowÄ… z PVGIS i liczy P50/P75/P90 z rzeczywistego rozkÅ‚adu rocznej produkcji. Do analiz inwestorskich.
        </div>

        <!-- Manual Factors (shown when pxxSource = 'manual') -->
        <div id="pxxManualSection">
          <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:#3f51b5">MnoÅ¼niki manualne:</div>
          <div class="settings-grid">
            <div class="setting-item">
              <label>P50 Factor</label>
              <input type="number" id="productionP50Factor" value="1.00" step="0.01" min="0.80" max="1.10">
              <span class="setting-hint">100% = mediana produkcji</span>
            </div>
            <div class="setting-item">
              <label>P75 Factor</label>
              <input type="number" id="productionP75Factor" value="0.97" step="0.01" min="0.80" max="1.05">
              <span class="setting-hint">97% = konserwatywny</span>
            </div>
            <div class="setting-item">
              <label>P90 Factor</label>
              <input type="number" id="productionP90Factor" value="0.94" step="0.01" min="0.80" max="1.00">
              <span class="setting-hint">94% = bardzo konserwatywny</span>
            </div>
          </div>
        </div>

        <!-- PVGIS Settings (shown when pxxSource != 'manual') -->
        <div id="pxxPvgisSection" style="display:none">
          <!-- Uncertainty Parameters -->
          <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:#3f51b5">Parametry niepewnoÅ›ci:</div>
          <div class="settings-grid" style="margin-bottom:16px">
            <div class="setting-item">
              <label>NiepewnoÅ›Ä‡ modelu [%]</label>
              <input type="number" id="pxxModelUncertaintyPct" value="3" step="0.5" min="0" max="10">
              <span class="setting-hint">BÅ‚Ä…d PR, invertera itp.</span>
            </div>
            <div class="setting-item">
              <label>Inne niepewnoÅ›ci [%]</label>
              <input type="number" id="pxxOtherUncertaintyPct" value="2" step="0.5" min="0" max="10">
              <span class="setting-hint">Soiling, konstrukcja itp.</span>
            </div>
          </div>

          <!-- PVGIS Configuration -->
          <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:#3f51b5">Konfiguracja PVGIS:</div>
          <div class="settings-grid">
            <div class="setting-item">
              <label>Baza danych radiacji</label>
              <select id="pvgisRadDatabase" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                <option value="PVGIS-SARAH3">PVGIS-SARAH3 (Europa, najnowsza)</option>
                <option value="PVGIS-SARAH2">PVGIS-SARAH2 (Europa)</option>
                <option value="PVGIS-ERA5">PVGIS-ERA5 (globalnie)</option>
              </select>
              <span class="setting-hint">Å¹rÃ³dÅ‚o danych nasÅ‚onecznienia</span>
            </div>
            <div class="setting-item">
              <label>Straty systemowe [%]</label>
              <input type="number" id="pvgisLossPct" value="14" step="1" min="5" max="25">
              <span class="setting-hint">Sumaryczne straty PV</span>
            </div>
            <div class="setting-item">
              <label>Technologia PV</label>
              <select id="pvgisPvTechChoice" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                <option value="crystSi">Krzemowy krystaliczny</option>
                <option value="CIS">CIS</option>
                <option value="CdTe">CdTe</option>
              </select>
              <span class="setting-hint">Typ moduÅ‚Ã³w PV</span>
            </div>
            <div class="setting-item">
              <label>Typ montaÅ¼u</label>
              <select id="pvgisMountingPlace" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                <option value="free">WolnostojÄ…ce (grunt)</option>
                <option value="building">Dach budynku</option>
              </select>
              <span class="setting-hint">WpÅ‚ywa na chÅ‚odzenie moduÅ‚Ã³w</span>
            </div>
          </div>

          <!-- Timeseries-specific settings -->
          <div id="pxxTimeseriesSettings" style="margin-top:16px;display:none">
            <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:#3f51b5">Zakres lat (timeseries):</div>
            <div class="settings-grid">
              <div class="setting-item">
                <label>Rok poczÄ…tkowy</label>
                <input type="number" id="pvgisStartYear" value="2005" step="1" min="2005" max="2020">
                <span class="setting-hint">Min. 10 lat zakresu</span>
              </div>
              <div class="setting-item">
                <label>Rok koÅ„cowy</label>
                <input type="number" id="pvgisEndYear" value="2020" step="1" min="2015" max="2023">
                <span class="setting-hint">Ostatnie dostÄ™pne dane</span>
              </div>
            </div>
          </div>

          <!-- Calculated Pxx Display -->
          <div id="pxxCalculatedDisplay" style="margin-top:16px;padding:12px;background:#e8f5e9;border-radius:6px;display:none">
            <div style="font-size:12px;font-weight:600;color:#2e7d32;margin-bottom:8px">ğŸ“Š Wyliczone mnoÅ¼niki Pxx:</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center">
              <div>
                <div style="font-size:11px;color:#666">P50</div>
                <div id="pxxCalcP50" style="font-size:18px;font-weight:700;color:#27ae60">100.0%</div>
              </div>
              <div>
                <div style="font-size:11px;color:#666">P75</div>
                <div id="pxxCalcP75" style="font-size:18px;font-weight:700;color:#3498db">â€“</div>
              </div>
              <div>
                <div style="font-size:11px;color:#666">P90</div>
                <div id="pxxCalcP90" style="font-size:18px;font-weight:700;color:#e74c3c">â€“</div>
              </div>
            </div>
            <div id="pxxCalcInfo" style="margin-top:8px;font-size:10px;color:#666;text-align:center"></div>
          </div>

          <!-- Fetch Button -->
          <div style="margin-top:16px;text-align:center">
            <button onclick="fetchPxxFromPVGIS()" class="btn btn-primary" style="padding:10px 24px">
              ğŸ”„ Pobierz Pxx z PVGIS
            </button>
            <div id="pxxFetchStatus" style="margin-top:8px;font-size:11px;color:#666"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- PV Installation Defaults - per type -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">â˜€ï¸</span>
        <h2>Parametry Instalacji PV</h2>
        <span class="setting-info">Uzysk i szerokoÅ›Ä‡ geograficzna dla kaÅ¼dego typu</span>
      </div>

      <!-- Ground South -->
      <div class="pv-type-section" style="margin-bottom:20px;padding:15px;background:#e8f5e9;border-radius:8px;border-left:4px solid #4caf50">
        <div style="font-weight:600;color:#2e7d32;margin-bottom:10px">ğŸŒ Grunt PoÅ‚udnie</div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Uzysk [kWh/kWp/rok]</label>
            <input type="number" id="pvYield_ground_s" value="1050" step="10">
          </div>
          <div class="setting-item">
            <label>SzerokoÅ›Ä‡ geogr. [Â°]</label>
            <input type="number" id="latitude_ground_s" value="52.0" step="0.1" min="49" max="55">
          </div>
          <div class="setting-item">
            <label>KÄ…t nachylenia [Â°]</label>
            <input type="number" id="tilt_ground_s" value="0" step="1" min="0" max="90">
            <span class="setting-hint">0 = auto (szerokoÅ›Ä‡ geogr.)</span>
          </div>
          <div class="setting-item">
            <label>Azymut [Â°]</label>
            <input type="number" id="azimuth_ground_s" value="180" step="5" min="0" max="360">
            <span class="setting-hint">180Â° = PoÅ‚udnie</span>
          </div>
        </div>
      </div>

      <!-- Roof East-West -->
      <div class="pv-type-section" style="margin-bottom:20px;padding:15px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
        <div style="font-weight:600;color:#1565c0;margin-bottom:10px">ğŸ  Dach WschÃ³d-ZachÃ³d</div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Uzysk [kWh/kWp/rok]</label>
            <input type="number" id="pvYield_roof_ew" value="950" step="10">
          </div>
          <div class="setting-item">
            <label>SzerokoÅ›Ä‡ geogr. [Â°]</label>
            <input type="number" id="latitude_roof_ew" value="52.0" step="0.1" min="49" max="55">
          </div>
          <div class="setting-item">
            <label>KÄ…t nachylenia [Â°]</label>
            <input type="number" id="tilt_roof_ew" value="10" step="1" min="0" max="90">
            <span class="setting-hint">Niski kÄ…t dla E-W</span>
          </div>
          <div class="setting-item">
            <label>Azymut E/W [Â°]</label>
            <input type="number" id="azimuth_roof_ew" value="90" step="5" min="0" max="360">
            <span class="setting-hint">90Â°=E, 270Â°=W</span>
          </div>
        </div>
      </div>

      <!-- Ground East-West -->
      <div class="pv-type-section" style="padding:15px;background:#fff3e0;border-radius:8px;border-left:4px solid #ff9800">
        <div style="font-weight:600;color:#e65100;margin-bottom:10px">ğŸŒ Grunt WschÃ³d-ZachÃ³d</div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Uzysk [kWh/kWp/rok]</label>
            <input type="number" id="pvYield_ground_ew" value="980" step="10">
          </div>
          <div class="setting-item">
            <label>SzerokoÅ›Ä‡ geogr. [Â°]</label>
            <input type="number" id="latitude_ground_ew" value="52.0" step="0.1" min="49" max="55">
          </div>
          <div class="setting-item">
            <label>KÄ…t nachylenia [Â°]</label>
            <input type="number" id="tilt_ground_ew" value="15" step="1" min="0" max="90">
            <span class="setting-hint">KÄ…t dla E-W grunt</span>
          </div>
          <div class="setting-item">
            <label>Azymut E/W [Â°]</label>
            <input type="number" id="azimuth_ground_ew" value="90" step="5" min="0" max="360">
            <span class="setting-hint">90Â°=E, 270Â°=W</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Location Resolver Section -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸ“</span>
        <h2>Lokalizacja Instalacji</h2>
        <span class="section-info">Wpisz miejscowoÅ›Ä‡ lub kod pocztowy, aby automatycznie pobraÄ‡ wspÃ³Å‚rzÄ™dne i wysokoÅ›Ä‡</span>
      </div>

      <!-- Info Box -->
      <div style="margin-bottom:16px;padding:12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
        <div style="font-size:12px;color:#1565c0;line-height:1.5">
          <strong>ğŸ’¡ Location Resolver</strong> automatycznie pobiera:<br>
          â€¢ SzerokoÅ›Ä‡ geograficznÄ… (latitude) - uÅ¼ywanÄ… do symulacji PV<br>
          â€¢ DÅ‚ugoÅ›Ä‡ geograficznÄ… (longitude) - dla PVGIS<br>
          â€¢ WysokoÅ›Ä‡ n.p.m. - wpÅ‚ywajÄ…cÄ… na irradiancjÄ™<br>
          <em>Dane z OpenStreetMap Nominatim + Open-Elevation API</em>
        </div>
      </div>

      <!-- Location Input -->
      <div style="display:flex;gap:12px;align-items:flex-end;flex-wrap:wrap;margin-bottom:20px">
        <div class="setting-item" style="flex:1;min-width:200px">
          <label>Kraj</label>
          <select id="geoCountry" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
            <option value="PL">ğŸ‡µğŸ‡± Polska</option>
            <option value="DE">ğŸ‡©ğŸ‡ª Niemcy</option>
            <option value="CZ">ğŸ‡¨ğŸ‡¿ Czechy</option>
            <option value="SK">ğŸ‡¸ğŸ‡° SÅ‚owacja</option>
            <option value="LT">ğŸ‡±ğŸ‡¹ Litwa</option>
            <option value="UA">ğŸ‡ºğŸ‡¦ Ukraina</option>
          </select>
        </div>
        <div class="setting-item" style="flex:1;min-width:150px">
          <label>Kod pocztowy</label>
          <input type="text" id="geoPostalCode" placeholder="np. 00-001" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
        </div>
        <div class="setting-item" style="flex:2;min-width:200px">
          <label>MiejscowoÅ›Ä‡</label>
          <input type="text" id="geoCity" placeholder="np. Warszawa" list="polishCitiesList" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
          <datalist id="polishCitiesList"></datalist>
        </div>
        <button onclick="resolveLocation()" class="btn btn-primary" style="padding:10px 24px;white-space:nowrap">
          ğŸ” ZnajdÅº lokalizacjÄ™
        </button>
      </div>

      <!-- Resolved Location Display -->
      <div id="geoResolvedSection" style="display:none;padding:16px;background:#e8f5e9;border-radius:8px;border-left:4px solid #4caf50;margin-bottom:16px">
        <div style="font-weight:600;color:#2e7d32;margin-bottom:12px">âœ… Znaleziona lokalizacja:</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:16px">
          <div>
            <div style="font-size:11px;color:#666">MiejscowoÅ›Ä‡</div>
            <div id="geoResolvedName" style="font-size:16px;font-weight:600;color:#333">â€“</div>
          </div>
          <div>
            <div style="font-size:11px;color:#666">SzerokoÅ›Ä‡ (lat)</div>
            <div id="geoResolvedLat" style="font-size:16px;font-weight:600;color:#1565c0">â€“</div>
          </div>
          <div>
            <div style="font-size:11px;color:#666">DÅ‚ugoÅ›Ä‡ (lon)</div>
            <div id="geoResolvedLon" style="font-size:16px;font-weight:600;color:#1565c0">â€“</div>
          </div>
          <div>
            <div style="font-size:11px;color:#666">WysokoÅ›Ä‡ n.p.m.</div>
            <div id="geoResolvedElev" style="font-size:16px;font-weight:600;color:#7b1fa2">â€“</div>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:12px">
          <button onclick="applyResolvedLocation()" class="btn btn-primary" style="padding:8px 16px">
            âœ“ Zastosuj do wszystkich typÃ³w instalacji
          </button>
          <button onclick="clearResolvedLocation()" class="btn btn-secondary" style="padding:8px 16px">
            âœ• WyczyÅ›Ä‡
          </button>
        </div>
        <div id="geoApplyStatus" style="margin-top:8px;font-size:11px;color:#666"></div>
      </div>

      <!-- Status message -->
      <div id="geoStatus" style="font-size:12px;color:#666;margin-bottom:8px"></div>
    </div>

    <!-- Environmental Parameters -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸŒ</span>
        <h2>Parametry Åšrodowiskowe (Zaawansowane)</h2>
        <span class="section-info">Dodatkowe parametry wpÅ‚ywajÄ…ce na dokÅ‚adnoÅ›Ä‡ symulacji</span>
      </div>

      <div class="settings-grid">
        <div class="setting-item">
          <label>WysokoÅ›Ä‡ npm [m]</label>
          <input type="number" id="altitude" value="100" step="10" min="0" max="2500">
          <span class="setting-hint">WysokoÅ›Ä‡ instalacji nad poziomem morza</span>
        </div>
        <div class="setting-item">
          <label>Albedo (reflektancja gruntu)</label>
          <input type="number" id="albedo" value="0.2" step="0.05" min="0.1" max="0.9">
          <span class="setting-hint">0.2=trawa, 0.3=beton, 0.8=Å›nieg</span>
        </div>
        <div class="setting-item">
          <label>Straty przez zabrudzenie [%]</label>
          <input type="number" id="soilingLoss" value="2" step="0.5" min="0" max="10">
          <span class="setting-hint">Typowo 2-3% dla Europy</span>
        </div>
      </div>

      <div style="margin-top:16px;padding:12px;background:#fff3e0;border-radius:8px;border-left:3px solid #ff9800">
        <div style="font-size:12px;color:#e65100">
          <strong>ğŸ’¡ WyjaÅ›nienia:</strong><br>
          <strong>WysokoÅ›Ä‡ npm:</strong> WyÅ¼sza wysokoÅ›Ä‡ = wyÅ¼sza irradiancja (cieÅ„sza atmosfera)<br>
          <strong>Albedo:</strong> Reflektancja gruntu wpÅ‚ywa na odbite promieniowanie. WyÅ¼sze albedo = wiÄ™cej odbicia = wyÅ¼sza produkcja<br>
          <strong>Soiling loss:</strong> Straty przez zabrudzenie paneli (kurz, pyÅ‚, liÅ›cie). ZaleÅ¼y od regionu i czÄ™stotliwoÅ›ci czyszczenia
        </div>
      </div>
    </div>

    <!-- DC/AC Ratio Tiers -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">âš¡</span>
        <h2>DC/AC Ratio wg wielkoÅ›ci instalacji</h2>
        <span class="section-info">WspÃ³Å‚czynnik DC/AC dla kaÅ¼dego przedziaÅ‚u mocy i typu montaÅ¼u</span>
      </div>

      <!-- Info Box -->
      <div style="margin-bottom:16px;padding:12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
        <div style="font-size:12px;color:#1565c0;line-height:1.5">
          <strong>ğŸ’¡ DC/AC Ratio (Oversizing)</strong> to stosunek mocy DC paneli do mocy AC falownika.<br>
          WyÅ¼sze ratio (np. 1.4) = wiÄ™cej paneli na falownik = wiÄ™cej energii rano/wieczorem, ale curtailment w szczycie.<br>
          <strong>Grunt PÅ‚d</strong> = panele na poÅ‚udnie (najwyÅ¼sza produkcja w szczycie) â†’ niÅ¼sze ratio.<br>
          <strong>Dach/Grunt E-W</strong> = panele wschÃ³d-zachÃ³d (rozproszona produkcja) â†’ wyÅ¼sze ratio.
        </div>
      </div>

      <!-- Slider korekty DC/AC -->
      <div style="margin-bottom:20px;padding:16px;background:#fff8e1;border-radius:8px;border-left:4px solid #ffc107">
        <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <label style="font-weight:600;color:#f57c00;display:block;margin-bottom:8px">
              ğŸšï¸ Korekta DC/AC (dla zaawansowanych)
            </label>
            <div style="display:flex;align-items:center;gap:12px">
              <span style="font-size:12px;color:#666">-0.10</span>
              <input type="range" id="dcacAdjustment"
                     min="-0.10" max="0.10" step="0.01" value="0"
                     style="flex:1;cursor:pointer"
                     oninput="updateDcacSlider(this.value)">
              <span style="font-size:12px;color:#666">+0.10</span>
            </div>
          </div>
          <div style="text-align:center;min-width:80px">
            <div style="font-size:11px;color:#666;margin-bottom:4px">Korekta</div>
            <div id="dcacAdjustmentDisplay" style="font-size:24px;font-weight:700;color:#666">0.00</div>
          </div>
        </div>
        <div style="margin-top:8px;font-size:11px;color:#795548">
          PrzesuÅ„ w lewo (-) jeÅ›li masz curtailment/ograniczenia sieciowe. PrzesuÅ„ w prawo (+) jeÅ›li masz niskÄ… cenÄ™ moduÅ‚Ã³w lub PPA z pÅ‚askÄ… cenÄ….
        </div>
      </div>

      <!-- Dynamic DC/AC Tiers Table Container -->
      <div id="dcac_tiers_container">
        <!-- Tabela bÄ™dzie renderowana dynamicznie przez JavaScript -->
      </div>
    </div>

    <!-- BESS - Battery Energy Storage System -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸ”‹</span>
        <h2>Magazyn Energii (BESS)</h2>
        <span class="section-info">Wybierz tryb: OFF / LIGHT / PRO</span>
      </div>

      <!-- Info Box -->
      <div style="margin-bottom:20px;padding:14px;background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);border-radius:10px;border-left:4px solid #1976d2">
        <div style="font-size:12px;color:#1565c0;line-height:1.6">
          <strong>ğŸ”‹ Tryby BESS:</strong><br>
          â€¢ <strong>OFF</strong> â€“ brak magazynu energii<br>
          â€¢ <strong>LIGHT</strong> â€“ prosty auto-sizing (algorytm zachÅ‚anny, szybkie obliczenia)<br>
          â€¢ <strong>PRO</strong> â€“ optymalizacja LP/MIP przez PyPSA+HiGHS (dokÅ‚adniejsze, wolniejsze)
        </div>
      </div>

      <!-- BESS Mode Selector (3-way) -->
      <div style="margin-bottom:24px;padding:20px;background:#fff;border-radius:8px;border:1px solid #e0e0e0">
        <div style="font-weight:600;color:#1976d2;font-size:15px;margin-bottom:12px">Tryb magazynu energii</div>
        <input type="hidden" id="bessEnabled"><!-- Legacy field for backwards compat -->

        <div style="display:flex;gap:12px">
          <div id="bessStatusOff" onclick="setBessMode('off')" style="flex:1;padding:16px 12px;background:#ffebee;border-radius:8px;text-align:center;border:2px solid #ef5350;cursor:pointer;transition:all 0.2s">
            <div style="font-size:24px">âŒ</div>
            <div style="font-weight:700;color:#c62828;font-size:14px;margin-top:4px">OFF</div>
            <div style="font-size:10px;color:#666;margin-top:2px">Bez magazynu</div>
          </div>
          <div id="bessStatusLight" onclick="setBessMode('light')" style="flex:1;padding:16px 12px;background:#e8f5e9;border-radius:8px;text-align:center;border:2px solid transparent;cursor:pointer;opacity:0.5;transition:all 0.2s">
            <div style="font-size:24px">âš¡</div>
            <div style="font-weight:700;color:#2e7d32;font-size:14px;margin-top:4px">LIGHT</div>
            <div style="font-size:10px;color:#666;margin-top:2px">Auto-sizing</div>
          </div>
          <div id="bessStatusPro" onclick="setBessMode('pro')" style="flex:1;padding:16px 12px;background:#fff3e0;border-radius:8px;text-align:center;border:2px solid transparent;cursor:pointer;opacity:0.5;transition:all 0.2s">
            <div style="font-size:24px">ğŸš€</div>
            <div style="font-weight:700;color:#e65100;font-size:14px;margin-top:4px">PRO</div>
            <div style="font-size:10px;color:#666;margin-top:2px">LP/MIP Optimizer</div>
          </div>
        </div>
        <input type="hidden" id="bessMode" value="off">
      </div>

      <!-- BESS Duration Selector (shown only when BESS enabled) -->
      <div id="bessDurationSection" style="display:none;margin-bottom:24px;padding:16px;background:#fff;border-radius:8px;border:1px solid #e0e0e0">
        <div style="font-weight:600;color:#1976d2;margin-bottom:12px;font-size:14px">
          â±ï¸ Czas magazynowania (Duration)
        </div>
        <div style="font-size:12px;color:#666;margin-bottom:12px">
          Stosunek pojemnoÅ›ci do mocy (E/P). AUTO testuje wszystkie opcje i wybiera najlepszÄ… wg NPV.
        </div>

        <div class="setting-item">
          <label>Duration</label>
          <select id="bessDuration" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
            <option value="auto">ğŸ¤– AUTO (optymalizacja NPV)</option>
            <option value="1">1h (wysoka moc, maÅ‚a pojemnoÅ›Ä‡)</option>
            <option value="2">2h (zbalansowany)</option>
            <option value="4">4h (duÅ¼a pojemnoÅ›Ä‡, umiarkowana moc)</option>
          </select>
          <span class="setting-hint">AUTO = system przetestuje 1h/2h/4h i wybierze najkorzystniejszy</span>
        </div>
      </div>

      <!-- BESS Economic Parameters (shown only when BESS enabled) -->
      <div id="bessEconomicsSection" style="display:none;margin-bottom:24px;padding:16px;background:#fff;border-radius:8px;border:1px solid #e0e0e0">
        <div style="font-weight:600;color:#1976d2;margin-bottom:12px;font-size:14px">
          ğŸ’° Parametry ekonomiczne BESS
        </div>

        <div class="settings-grid">
          <div class="setting-item">
            <label>CAPEX per kWh</label>
            <input type="number" id="bessCapexPerKwh" value="1500" min="500" max="5000" step="50">
            <span class="setting-hint">PLN/kWh (bateria + BMS)</span>
          </div>
          <div class="setting-item">
            <label>CAPEX per kW</label>
            <input type="number" id="bessCapexPerKw" value="300" min="0" max="2000" step="50">
            <span class="setting-hint">PLN/kW (PCS/inwerter+EMS)</span>
          </div>
          <div class="setting-item">
            <label>OPEX (% CAPEX/rok)</label>
            <input type="number" id="bessOpexPctPerYear" value="1.5" min="0" max="5" step="0.1">
            <span class="setting-hint">Roczny koszt serwisu</span>
          </div>
          <div class="setting-item">
            <label>Å»ywotnoÅ›Ä‡ [lat]</label>
            <input type="number" id="bessLifetimeYears" value="15" min="5" max="25" step="1">
            <span class="setting-hint">Oczekiwana Å¼ywotnoÅ›Ä‡</span>
          </div>
        </div>
      </div>

      <!-- BESS Technical Parameters (Advanced, collapsed by default) -->
      <div id="bessTechnicalSection" style="display:none">
        <details style="margin-bottom:16px">
          <summary style="cursor:pointer;padding:12px;background:#f5f5f5;border-radius:6px;font-weight:600;color:#555">
            âš™ï¸ Parametry techniczne (zaawansowane)
          </summary>
          <div style="padding:16px;background:#fff;border:1px solid #e0e0e0;border-top:none;border-radius:0 0 8px 8px">
            <div class="settings-grid">
              <div class="setting-item">
                <label>SprawnoÅ›Ä‡ roundtrip</label>
                <input type="number" id="bessRoundtripEfficiency" value="90" min="80" max="98" step="1">
                <span class="setting-hint">% (typowo 88-92% dla Li-ion)</span>
              </div>
              <div class="setting-item">
                <label>SOC min</label>
                <input type="number" id="bessSocMin" value="10" min="0" max="30" step="5">
                <span class="setting-hint">% (ochrona baterii)</span>
              </div>
              <div class="setting-item">
                <label>SOC max</label>
                <input type="number" id="bessSocMax" value="90" min="70" max="100" step="5">
                <span class="setting-hint">% (ochrona baterii)</span>
              </div>
              <div class="setting-item">
                <label>Degradacja rok 1</label>
                <input type="number" id="bessDegradationYear1" value="3.0" min="0" max="10" step="0.1">
                <span class="setting-hint">% (pierwszy rok - wyÅ¼sza)</span>
              </div>
              <div class="setting-item">
                <label>Degradacja lata 2+</label>
                <input type="number" id="bessDegradationPctPerYear" value="2.0" min="0" max="5" step="0.1">
                <span class="setting-hint">% (pozostaÅ‚e lata)</span>
              </div>
            </div>
          </div>
        </details>
      </div>

      <!-- BESS PRO Parameters (shown only when PRO mode selected) -->
      <div id="bessProSection" style="display:none;margin-bottom:24px;padding:16px;background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);border-radius:8px;border:1px solid #ffb74d">
        <div style="font-weight:600;color:#e65100;margin-bottom:12px;font-size:14px">
          ğŸš€ BESS PRO â€“ Optymalizacja LP/MIP (PyPSA + HiGHS)
        </div>
        <div style="font-size:11px;color:#666;margin-bottom:16px">
          Zaawansowana optymalizacja doboru mocy i pojemnoÅ›ci magazynu przez programowanie liniowe.
          UwzglÄ™dnia peÅ‚ny profil godzinowy (8760h) i ograniczenie 0-Export.
        </div>

        <!-- PRO Sizing Constraints -->
        <div style="margin-bottom:16px">
          <div style="font-weight:600;color:#bf360c;font-size:12px;margin-bottom:8px">ğŸ“ Ograniczenia wymiarowania</div>
          <div class="settings-grid">
            <div class="setting-item">
              <label>Min moc [kW]</label>
              <input type="number" id="bessProMinPowerKw" value="50" min="0" max="10000" step="10">
              <span class="setting-hint">Minimalna moc BESS</span>
            </div>
            <div class="setting-item">
              <label>Max moc [kW]</label>
              <input type="number" id="bessProMaxPowerKw" value="10000" min="100" max="100000" step="100">
              <span class="setting-hint">Maksymalna moc BESS</span>
            </div>
            <div class="setting-item">
              <label>Min pojemnoÅ›Ä‡ [kWh]</label>
              <input type="number" id="bessProMinEnergyKwh" value="100" min="0" max="50000" step="100">
              <span class="setting-hint">Minimalna pojemnoÅ›Ä‡</span>
            </div>
            <div class="setting-item">
              <label>Max pojemnoÅ›Ä‡ [kWh]</label>
              <input type="number" id="bessProMaxEnergyKwh" value="50000" min="100" max="500000" step="500">
              <span class="setting-hint">Maksymalna pojemnoÅ›Ä‡</span>
            </div>
            <div class="setting-item">
              <label>Duration min [h]</label>
              <input type="number" id="bessProDurationMin" value="1" min="0.5" max="4" step="0.5">
              <span class="setting-hint">Min stosunek E/P</span>
            </div>
            <div class="setting-item">
              <label>Duration max [h]</label>
              <input type="number" id="bessProDurationMax" value="4" min="1" max="8" step="0.5">
              <span class="setting-hint">Max stosunek E/P</span>
            </div>
          </div>
        </div>

        <!-- PRO Optimization Settings -->
        <div style="margin-bottom:16px">
          <div style="font-weight:600;color:#bf360c;font-size:12px;margin-bottom:8px">âš™ï¸ Ustawienia optymalizacji</div>
          <div class="settings-grid">
            <div class="setting-item">
              <label>Solver</label>
              <select id="bessProSolver" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="highs">HiGHS (zalecany)</option>
                <option value="glpk">GLPK</option>
                <option value="cbc">CBC</option>
              </select>
              <span class="setting-hint">Open-source LP/MIP solver</span>
            </div>
            <div class="setting-item">
              <label>Cel optymalizacji</label>
              <select id="bessProObjective" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="npv">Maksymalizacja NPV</option>
                <option value="payback">Minimalizacja payback</option>
                <option value="autoconsumption">Max autokonsumpcja</option>
              </select>
              <span class="setting-hint">Funkcja celu</span>
            </div>
            <div class="setting-item">
              <label>RozdzielczoÅ›Ä‡ czasowa</label>
              <select id="bessProTimeResolution" style="width:100%;padding:8px;border:1px solid #ddd;border-radius:4px">
                <option value="hourly">Godzinowa (8760 krokÃ³w)</option>
                <option value="15min">15-minutowa (35040 krokÃ³w)</option>
              </select>
              <span class="setting-hint">Im wyÅ¼sza, tym wolniej</span>
            </div>
            <div class="setting-item">
              <label>Typowe dni (kompresja)</label>
              <input type="number" id="bessProTypicalDays" value="0" min="0" max="365" step="1">
              <span class="setting-hint">0 = peÅ‚ny rok, >0 = kompresja</span>
            </div>
          </div>
        </div>

        <!-- PRO Zero-Export Settings -->
        <div>
          <div style="font-weight:600;color:#bf360c;font-size:12px;margin-bottom:8px">ğŸš« Ograniczenie 0-Export</div>
          <div class="settings-grid">
            <div class="setting-item">
              <label style="display:flex;align-items:center;gap:8px">
                <input type="checkbox" id="bessProZeroExport" checked style="width:18px;height:18px">
                Wymuszenie 0-Export
              </label>
              <span class="setting-hint">Brak eksportu do sieci</span>
            </div>
            <div class="setting-item">
              <label>Kara za eksport [PLN/MWh]</label>
              <input type="number" id="bessProExportPenalty" value="1000" min="0" max="10000" step="100">
              <span class="setting-hint">Soft constraint (gdy 0-Export off)</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ESG - Environmental, Social, Governance -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸŒ±</span>
        <h2>ESG â€“ Emisje i Klimat</h2>
        <span class="section-info">Parametry Å›ladu wÄ™glowego i zgodnoÅ›ci ESG</span>
      </div>

      <!-- Info Box -->
      <div style="margin-bottom:20px;padding:14px;background:linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);border-radius:10px;border-left:4px solid #4caf50">
        <div style="font-size:12px;color:#2e7d32;line-height:1.6">
          <strong>ğŸŒ Sekcja ESG</strong> umoÅ¼liwia raportowanie wpÅ‚ywu Å›rodowiskowego projektu PV zgodnie z wymogami CSRD, EU Taxonomy i GHG Protocol.<br>
          â€¢ <strong>Scope 2</strong> â€“ emisje poÅ›rednie z zakupionej energii elektrycznej<br>
          â€¢ <strong>Embodied carbon</strong> â€“ Å›lad wÄ™glowy produkcji moduÅ‚Ã³w PV (LCA)<br>
          â€¢ <strong>Carbon payback</strong> â€“ czas "spÅ‚aty" emisji z produkcji moduÅ‚Ã³w
        </div>
      </div>

      <!-- Grid Emission Factor - Electricity Maps -->
      <div style="margin-bottom:24px;padding:16px;background:#fff;border-radius:8px;border:1px solid #e0e0e0">
        <div style="font-weight:600;color:#1b5e20;margin-bottom:12px;font-size:14px">
          âš¡ WspÃ³Å‚czynnik emisji sieci (EF_grid)
        </div>

        <div class="setting-item" style="margin-bottom:12px">
          <label>Å¹rÃ³dÅ‚o danych</label>
          <div style="padding:10px;background:#e8f5e9;border-radius:6px;color:#2e7d32;font-weight:600">
            Electricity Maps API
          </div>
        </div>

        <!-- Electricity Maps API settings -->
        <div class="settings-grid">
          <div class="setting-item">
            <label>API Key</label>
            <input type="text" id="electricitymapsApiKey" value="zKpYPh29dwX3dtT3StlM" readonly style="background:#f5f5f5">
            <span class="setting-hint"><a href="https://www.electricitymaps.com/" target="_blank">electricitymaps.com</a></span>
          </div>
          <div class="setting-item">
            <label>Strefa (Zone)</label>
            <select id="electricitymapsZone" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
              <option value="PL">Polska (PL)</option>
              <option value="DE">Niemcy (DE)</option>
              <option value="CZ">Czechy (CZ)</option>
              <option value="SK">SÅ‚owacja (SK)</option>
              <option value="UA">Ukraina (UA)</option>
              <option value="LT">Litwa (LT)</option>
            </select>
          </div>
          <div class="setting-item">
            <label>Typ emisji</label>
            <select id="electricitymapsEmissionType" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
              <option value="lifecycle">Lifecycle (peÅ‚ny LCA)</option>
              <option value="direct">Direct (tylko spalanie)</option>
            </select>
          </div>
        </div>

        <!-- Current EF_grid value -->
        <div style="margin-top:16px;padding:12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
          <div class="settings-grid">
            <div class="setting-item">
              <label>EF_grid [kgCO2e/kWh]</label>
              <input type="number" id="esgGridEmissionFactor" value="0.658" step="0.001" min="0" max="2">
              <span class="setting-hint">Aktualna wartoÅ›Ä‡ dla obliczeÅ„</span>
            </div>
            <div class="setting-item">
              <label>Å¹rÃ³dÅ‚o</label>
              <input type="text" id="esgGridEmissionSource" value="Electricity Maps" readonly style="background:#f5f5f5">
            </div>
          </div>
        </div>

        <!-- Hidden fields for compatibility -->
        <input type="hidden" id="esgGridEmissionProvider" value="electricitymaps">
        <input type="hidden" id="esgGridEmissionYear" value="2023">
      </div>

      <!-- Embodied Carbon (LCA) -->
      <div style="margin-bottom:24px;padding:16px;background:#fff;border-radius:8px;border:1px solid #e0e0e0">
        <div style="font-weight:600;color:#1565c0;margin-bottom:12px;font-size:14px">
          ğŸ­ Embodied Carbon (LCA moduÅ‚Ã³w PV)
        </div>

        <div class="setting-item" style="margin-bottom:12px">
          <label>Technologia PV projektu</label>
          <select id="esgPvTechnology" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
            <option value="crystalline">Krzemowe krystaliczne (c-Si) â€“ najpopularniejsze</option>
            <option value="CIS">CIS/CIGS (Copper Indium Selenide)</option>
            <option value="CdTe">CdTe (Cadmium Telluride) â€“ thin-film</option>
          </select>
        </div>

        <div class="settings-grid">
          <div class="setting-item">
            <label>c-Si [kgCOâ‚‚e/kWp]</label>
            <input type="number" id="esgEmbodiedCarbonCrystalline" value="700" step="10" min="300" max="1200">
            <span class="setting-hint">Typowo: 600-800</span>
          </div>
          <div class="setting-item">
            <label>CIS [kgCOâ‚‚e/kWp]</label>
            <input type="number" id="esgEmbodiedCarbonCIS" value="600" step="10" min="300" max="1000">
            <span class="setting-hint">Typowo: 500-700</span>
          </div>
          <div class="setting-item">
            <label>CdTe [kgCOâ‚‚e/kWp]</label>
            <input type="number" id="esgEmbodiedCarbonCdTe" value="500" step="10" min="200" max="800">
            <span class="setting-hint">Typowo: 400-600</span>
          </div>
        </div>

        <div class="setting-item" style="margin-top:12px">
          <label>Å¹rÃ³dÅ‚o danych LCA</label>
          <input type="text" id="esgEmbodiedCarbonSource" value="IEA PVPS Task 12 / NREL" style="width:100%">
        </div>
      </div>

      <!-- EU Taxonomy & Governance -->
      <div style="padding:16px;background:#fff;border-radius:8px;border:1px solid #e0e0e0">
        <div style="font-weight:600;color:#7b1fa2;margin-bottom:12px;font-size:14px">
          ğŸ“‹ Governance / Compliance
        </div>

        <div class="settings-grid">
          <div class="setting-item">
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="esgTaxonomyAligned" checked style="width:18px;height:18px">
              ZgodnoÅ›Ä‡ z EU Taxonomy
            </label>
            <span class="setting-hint">DziaÅ‚alnoÅ›Ä‡ 4.1 â€“ Wytwarzanie energii z PV</span>
          </div>
          <div class="setting-item">
            <label>Kod dziaÅ‚alnoÅ›ci</label>
            <input type="text" id="esgTaxonomyActivityCode" value="4.1" style="width:100px">
          </div>
          <div class="setting-item">
            <label>Metoda raportowania</label>
            <select id="esgReportingMethod" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px">
              <option value="location">Location-based (EF z sieci krajowej)</option>
              <option value="market">Market-based (EF z kontraktÃ³w/GO)</option>
            </select>
          </div>
        </div>

        <div class="setting-item" style="margin-top:12px">
          <label>Certyfikaty komponentÃ³w</label>
          <input type="text" id="esgComponentCompliance" value="Tier 1, EPD, RoHS, ISO 9001/14001" style="width:100%">
          <span class="setting-hint">Deklaracja zgodnoÅ›ci komponentÃ³w PV</span>
        </div>
      </div>

      <!-- ESG Summary Info -->
      <div style="margin-top:20px;padding:14px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
        <div style="font-size:12px;color:#1565c0;line-height:1.5">
          <strong>ğŸ“Š Obliczane KPI ESG:</strong><br>
          â€¢ <strong>COâ‚‚ reduction/year</strong> â€“ roczna redukcja emisji Scope 2<br>
          â€¢ <strong>COâ‚‚ lifetime</strong> â€“ Å‚Ä…czna redukcja w okresie Å¼ycia projektu<br>
          â€¢ <strong>Carbon payback</strong> â€“ lata do "spÅ‚aty" embodied carbon<br>
          â€¢ <strong>Share RES</strong> â€“ udziaÅ‚ OZE w zuÅ¼yciu energii po wdroÅ¼eniu PV<br>
          â€¢ <strong>Net COâ‚‚</strong> â€“ bilans netto (avoided - embodied)
        </div>
      </div>
    </div>

    <!-- Operational Calendar Section -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸ­</span>
        <h2>Kalendarz Operacyjny</h2>
        <span class="section-info">Godziny pracy zakÅ‚adu i tryb zmianowy</span>
      </div>

      <!-- Info Box -->
      <div style="margin-bottom:16px;padding:12px;background:#fff3e0;border-radius:8px;border-left:4px solid #ff9800">
        <div style="font-size:12px;color:#e65100;line-height:1.5">
          <strong>ğŸ’¡ Kalendarz operacyjny</strong> okreÅ›la, kiedy zakÅ‚ad zuÅ¼ywa energiÄ™.<br>
          UÅ¼ywany do dokÅ‚adniejszej kalkulacji autokonsumpcji i opÅ‚aty mocowej (godziny szczytu 7-21 w dni robocze).<br>
          <em>Polskie Å›wiÄ™ta sÄ… automatycznie uwzglÄ™dniane.</em>
        </div>
      </div>

      <!-- Operating Mode Selection -->
      <div class="setting-item" style="margin-bottom:16px">
        <label style="font-weight:600;color:#e65100">Tryb pracy zakÅ‚adu</label>
        <select id="operatingMode" onchange="toggleOperatingModeFields()" style="width:100%;max-width:400px;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
          <option value="24_7">Praca ciÄ…gÅ‚a 24/7 (caÅ‚odobowo)</option>
          <option value="workdays">Tylko dni robocze (Pn-Pt, bez Å›wiÄ…t)</option>
          <option value="custom">Niestandardowe godziny pracy</option>
        </select>
      </div>

      <!-- Custom Hours Section (hidden by default) -->
      <div id="customHoursSection" style="display:none;padding:16px;background:#fff;border:1px solid #e0e0e0;border-radius:8px;margin-bottom:16px">
        <div style="font-weight:600;color:#333;margin-bottom:12px">â° Godziny pracy zakÅ‚adu</div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>PoczÄ…tek pracy (godzina)</label>
            <input type="number" id="workHourStart" value="6" step="1" min="0" max="23">
            <span class="setting-hint">Np. 6 = 06:00</span>
          </div>
          <div class="setting-item">
            <label>Koniec pracy (godzina)</label>
            <input type="number" id="workHourEnd" value="22" step="1" min="1" max="24">
            <span class="setting-hint">Np. 22 = 22:00</span>
          </div>
          <div class="setting-item">
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="workOnSaturdays" style="width:18px;height:18px">
              Praca w soboty
            </label>
          </div>
          <div class="setting-item">
            <label style="display:flex;align-items:center;gap:8px">
              <input type="checkbox" id="workOnSundays" style="width:18px;height:18px">
              Praca w niedziele
            </label>
          </div>
        </div>
      </div>

      <!-- Peak Hours (Capacity Fee) -->
      <div style="padding:16px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
        <div style="font-weight:600;color:#1565c0;margin-bottom:12px">âš¡ Godziny szczytu (opÅ‚ata mocowa)</div>
        <div style="margin-bottom:12px;font-size:12px;color:#666">
          OpÅ‚ata mocowa naliczana jest tylko za energiÄ™ pobranÄ… w godzinach szczytu w dni robocze.
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>PoczÄ…tek szczytu</label>
            <input type="number" id="peakHourStart" value="7" step="1" min="0" max="23">
            <span class="setting-hint">DomyÅ›lnie: 7 (07:00)</span>
          </div>
          <div class="setting-item">
            <label>Koniec szczytu</label>
            <input type="number" id="peakHourEnd" value="21" step="1" min="1" max="24">
            <span class="setting-hint">DomyÅ›lnie: 21 (21:00)</span>
          </div>
        </div>
        <div style="margin-top:12px;font-size:11px;color:#666">
          <strong>Uwaga:</strong> Zgodnie z URE, godziny szczytu to 7:00-21:00 w dni robocze (bez Å›wiÄ…t).
        </div>
      </div>
    </div>

    <!-- Analysis Range -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸ”</span>
        <h2>Zakres Analizy</h2>
        <span class="section-info">PrzedziaÅ‚y mocy do analizy</span>
      </div>
      <div class="settings-grid">
        <div class="setting-item">
          <label>Moc minimalna [kWp]</label>
          <input type="number" id="capMin" value="1000" step="100">
        </div>
        <div class="setting-item">
          <label>Moc maksymalna [kWp]</label>
          <input type="number" id="capMax" value="50000" step="1000">
        </div>
        <div class="setting-item">
          <label>Krok [kWp]</label>
          <input type="number" id="capStep" value="500" step="100">
        </div>
      </div>
    </div>

    <!-- Optimization Thresholds -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">ğŸ¯</span>
        <h2>Progi Autokonsumpcji</h2>
        <span class="section-info">Warianty A, B, C, D [%]</span>
      </div>
      <div class="settings-grid threshold-grid">
        <div class="setting-item threshold-a">
          <label>Wariant A</label>
          <input type="number" id="thrA" value="95" min="50" max="100">
          <span class="setting-hint">NajwyÅ¼sza autokonsumpcja</span>
        </div>
        <div class="setting-item threshold-b">
          <label>Wariant B</label>
          <input type="number" id="thrB" value="90" min="50" max="100">
        </div>
        <div class="setting-item threshold-c">
          <label>Wariant C</label>
          <input type="number" id="thrC" value="85" min="50" max="100">
        </div>
        <div class="setting-item threshold-d">
          <label>Wariant D</label>
          <input type="number" id="thrD" value="80" min="50" max="100">
          <span class="setting-hint">NajniÅ¼sza autokonsumpcja</span>
        </div>
      </div>
    </div>

  </div>

  <div class="settings-footer">
    <button class="btn btn-primary" onclick="saveAllSettings()">ğŸ’¾ ZAPISZ USTAWIENIA</button>
    <button class="btn btn-secondary" onclick="resetToDefaults()">ğŸ”„ PRZYWRÃ“Ä† DOMYÅšLNE</button>
    <button class="btn btn-export" onclick="exportSettings()">ğŸ“¥ EKSPORT</button>
    <button class="btn btn-import" onclick="importSettings()">ğŸ“¤ IMPORT</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">
  </div>

  <div id="saveStatus" class="save-status"></div>
</div>

<script>
// Feature flag based access control for EaaS section
// TODO: Replace with proper backend JWT auth when available
// For now, uses a simple role check from localStorage

const USER_ROLES = {
  ADMIN: 'admin',
  ENGINEER: 'engineer',
  SALES: 'sales'
};

// Check if user has elevated access (engineer or admin role)
function hasEaasAccess() {
  const userRole = localStorage.getItem('pv_user_role');
  return userRole === USER_ROLES.ADMIN || userRole === USER_ROLES.ENGINEER;
}

// Unlock EaaS section with role verification
function unlockEaasSection() {
  // First check if user already has access via role
  if (hasEaasAccess()) {
    showEaasSection();
    return;
  }

  // Fallback: prompt for role selection (temporary until auth is implemented)
  const roleOptions = ['admin', 'engineer', 'sales'];
  const selectedRole = prompt(
    'Wybierz swojÄ… rolÄ™:\n' +
    'â€¢ admin - peÅ‚ny dostÄ™p\n' +
    'â€¢ engineer - dostÄ™p do parametrÃ³w technicznych\n' +
    'â€¢ sales - podstawowy dostÄ™p\n\n' +
    'WprowadÅº rolÄ™:'
  );

  if (selectedRole && roleOptions.includes(selectedRole.toLowerCase())) {
    localStorage.setItem('pv_user_role', selectedRole.toLowerCase());

    if (selectedRole.toLowerCase() === 'admin' || selectedRole.toLowerCase() === 'engineer') {
      showEaasSection();
    } else {
      alert('âš ï¸ Rola "sales" nie ma dostÄ™pu do parametrÃ³w EaaS.\nSkontaktuj siÄ™ z administratorem.');
    }
  } else if (selectedRole !== null) {
    alert('âŒ Nieznana rola. DostÄ™pne: admin, engineer, sales');
  }
}

function showEaasSection() {
  document.getElementById('eaasPasswordSection').style.display = 'none';
  document.getElementById('eaasParamsSection').style.display = 'block';

  // Show success message
  const saveStatus = document.getElementById('saveStatus');
  saveStatus.textContent = 'âœ… Parametry EaaS odblokowane';
  saveStatus.className = 'save-status success';
  setTimeout(() => {
    saveStatus.className = 'save-status';
  }, 3000);
}

// Auto-unlock if user already has access
document.addEventListener('DOMContentLoaded', function() {
  if (hasEaasAccess()) {
    showEaasSection();
  }
});
</script>

<script src="settings.js"></script>
</body>
</html>
