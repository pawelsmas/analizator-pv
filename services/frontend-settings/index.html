<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ustawienia Systemu</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
<div class="settings-container">
  <div class="settings-header">
    <h1>‚öôÔ∏è USTAWIENIA SYSTEMU</h1>
    <p>Centralna konfiguracja wszystkich parametr√≥w analizy PV</p>
  </div>

  <div class="settings-content">
    <!-- Energy Tariff Section -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">üí°</span>
        <h2>Taryfa Energetyczna</h2>
        <span class="section-info">Sk≈Çadniki ceny energii [PLN/MWh]</span>
      </div>
      <div class="settings-grid">
        <div class="setting-item">
          <label>Energia czynna</label>
          <input type="number" id="energyActive" value="550" step="10">
          <span class="setting-hint">Podstawowa stawka za energiƒô</span>
        </div>
        <div class="setting-item">
          <label>Dystrybucja</label>
          <input type="number" id="distribution" value="200" step="10">
          <span class="setting-hint">Op≈Çata dystrybucyjna</span>
        </div>
        <div class="setting-item">
          <label>Op≈Çata jako≈õciowa</label>
          <input type="number" id="qualityFee" value="10" step="1">
          <span class="setting-hint">Za jako≈õƒá energii</span>
        </div>
        <div class="setting-item">
          <label>Op≈Çata OZE</label>
          <input type="number" id="ozeFee" value="7" step="1">
          <span class="setting-hint">Wsparcie OZE</span>
        </div>
        <div class="setting-item">
          <label>Op≈Çata kogeneracyjna</label>
          <input type="number" id="cogenerationFee" value="10" step="1">
          <span class="setting-hint">Wsparcie kogeneracji</span>
        </div>
        <div class="setting-item">
          <label>Op≈Çata mocowa (7-21)</label>
          <input type="number" id="capacityFee" value="219" step="10">
          <span class="setting-hint">Godziny szczytu</span>
        </div>
        <div class="setting-item">
          <label>Akcyza</label>
          <input type="number" id="exciseTax" value="5" step="1">
          <span class="setting-hint">Podatek akcyzowy</span>
        </div>
        <div class="setting-item highlight">
          <label>SUMA</label>
          <input type="number" id="totalEnergyPrice" value="1001" readonly>
          <span class="setting-hint">Ca≈Çkowita cena energii</span>
        </div>
      </div>
    </div>

    <!-- CAPEX Tiers Section - Per Installation Type -->
    <div class="settings-section" style="grid-column: span 2;">
      <div class="section-header">
        <span class="section-icon">üí∞</span>
        <h2>Przedzia≈Çy CAPEX wg typu instalacji</h2>
        <span class="section-info">Koszt, mar≈ºa i cena sprzeda≈ºy [PLN/kWp]</span>
      </div>

      <div style="margin-bottom:16px;padding:12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
        <div style="font-size:12px;color:#1565c0">
          <strong>üí° Obja≈õnienia:</strong><br>
          <strong>Koszt/kWp</strong> - koszt zakupu i instalacji dla danego przedzia≈Çu mocy<br>
          <strong>Mar≈ºa [%]</strong> - mar≈ºa handlowa (krok 0.1%, np. 17.0%, 17.5%, 18.3%)<br>
          <strong>Sprzeda≈º/kWp</strong> - cena sprzeda≈ºy = Koszt / (1 - Mar≈ºa/100)<br>
          <em>Przyk≈Çad: Koszt 2000 PLN, Mar≈ºa 20% ‚Üí 2000 / 0.80 = 2500 PLN</em>
        </div>
      </div>

      <!-- Tab Navigation -->
      <div class="capex-tabs" style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap">
        <button class="capex-tab active" onclick="showCapexTab('ground_s')" id="tab_ground_s" style="padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;background:#4caf50;color:white">
          üåç Grunt Po≈Çudnie
        </button>
        <button class="capex-tab" onclick="showCapexTab('ground_ew')" id="tab_ground_ew" style="padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;background:#f5f5f5;color:#666">
          üåç Grunt E-W
        </button>
        <button class="capex-tab" onclick="showCapexTab('roof_ew')" id="tab_roof_ew" style="padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;background:#f5f5f5;color:#666">
          üè† Dach E-W
        </button>
        <button class="capex-tab" onclick="showCapexTab('carport')" id="tab_carport" style="padding:10px 16px;border:none;border-radius:6px;cursor:pointer;font-weight:600;background:#f5f5f5;color:#666">
          üöó Carport
        </button>
      </div>

      <!-- Dynamiczne panele CAPEX per typ - renderowane przez JavaScript -->
      <div id="capex_ground_s" class="capex-panel" style="display:block"></div>
      <div id="capex_ground_ew" class="capex-panel" style="display:none"></div>
      <div id="capex_roof_ew" class="capex-panel" style="display:none"></div>
      <div id="capex_carport" class="capex-panel" style="display:none"></div>

    </div>

    <!-- OPEX Section -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">üîß</span>
        <h2>Koszty Operacyjne (OPEX)</h2>
        <span class="section-info">Roczne koszty eksploatacji</span>
      </div>
      <div class="settings-grid">
        <div class="setting-item">
          <label>OPEX [PLN/kWp/rok]</label>
          <input type="number" id="opexPerKwp" value="15" step="1">
          <span class="setting-hint">Koszty serwisu i utrzymania</span>
        </div>
        <div class="setting-item">
          <label>O&M EaaS [PLN/kWp/rok]</label>
          <input type="number" id="eaasOM" value="24" step="1">
          <span class="setting-hint">Koszty O&M w modelu EaaS</span>
        </div>
        <div class="setting-item">
          <label>Ubezpieczenie [% CAPEX/rok]</label>
          <input type="number" id="insuranceRate" value="0.3" step="0.1" min="0" max="2">
          <span class="setting-hint">Stawka ubezpieczenia</span>
        </div>
        <div class="setting-item">
          <label>Najem powierzchni [PLN/kWp/rok]</label>
          <input type="number" id="landLeasePerKwp" value="0" step="1" min="0">
          <span class="setting-hint">Koszt dzier≈ºawy gruntu</span>
        </div>
      </div>
    </div>

    <!-- Financial Parameters Section -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">üìä</span>
        <h2>Parametry Finansowe</h2>
        <span class="section-info">Stopy, okresy i wska≈∫niki</span>
      </div>
      <div class="settings-grid">
        <div class="setting-item">
          <label>Stopa dyskontowa [%]</label>
          <input type="number" id="discountRate" value="7" step="0.5" min="0" max="20">
          <span class="setting-hint">Do obliczenia NPV</span>
        </div>
        <div class="setting-item">
          <label>Degradacja PV [%/rok]</label>
          <input type="number" id="degradationRate" value="0.5" step="0.1" min="0" max="2">
          <span class="setting-hint">Spadek wydajno≈õci</span>
        </div>
        <div class="setting-item">
          <label>Okres analizy [lat]</label>
          <input type="number" id="analysisPeriod" value="25" step="1" min="10" max="30">
          <span class="setting-hint">Horyzont czasowy</span>
        </div>
        <div class="setting-item">
          <label>Inflacja [%/rok]</label>
          <input type="number" id="inflationRate" value="2.5" step="0.5" min="0" max="10">
          <span class="setting-hint">Wzrost cen energii</span>
        </div>
      </div>

      <!-- IRR Calculation Mode -->
      <div style="margin-top:20px;padding:16px;background:#fff8e1;border-radius:8px;border-left:4px solid #ffc107">
        <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
          <input type="checkbox" id="useInflation" style="width:20px;height:20px;cursor:pointer">
          <label for="useInflation" style="font-weight:600;color:#f57c00;cursor:pointer;margin:0">
            Uwzglƒôdniaj inflacjƒô w obliczeniu IRR (tryb nominalny)
          </label>
        </div>
        <div style="font-size:12px;color:#795548;margin-left:32px">
          <strong>Wy≈ÇƒÖczone (domy≈õlnie):</strong> IRR realny - sta≈Çe ceny energii i OPEX przez ca≈Çy okres analizy<br>
          <strong>W≈ÇƒÖczone:</strong> IRR nominalny - ceny energii, OPEX i taryfy feed-in indeksowane o inflacjƒô rocznie
        </div>
      </div>
    </div>

    <!-- EaaS Parameters Section (Password Protected) -->
    <div class="settings-section" id="eaasPasswordSection">
      <div class="section-header">
        <span class="section-icon">üîí</span>
        <h2>Parametry EaaS (Energy-as-a-Service)</h2>
        <span class="section-info">Sekcja chroniona has≈Çem</span>
      </div>
      <div style="text-align:center;padding:40px">
        <button onclick="unlockEaasSection()" style="padding:12px 24px;background:#4caf50;color:white;border:none;border-radius:6px;font-size:14px;cursor:pointer;font-weight:600">
          üîì Poka≈º parametry EaaS
        </button>
      </div>
    </div>

    <!-- EaaS Parameters Section (Hidden by default) -->
    <div class="settings-section" id="eaasParamsSection" style="display:none">
      <div class="section-header">
        <span class="section-icon">üìã</span>
        <h2>Parametry EaaS (Energy-as-a-Service)</h2>
        <span class="section-info">Pe≈Çny model inwestorski - kalkulacja abonamentu na podstawie docelowego IRR</span>
      </div>

      <div style="margin-bottom:20px;padding:16px;background:#e8f5e9;border-radius:8px;border-left:4px solid #4caf50">
        <div style="font-size:13px;font-weight:600;color:#2e7d32;margin-bottom:8px">üí° Jak dzia≈Ça kalkulacja EaaS?</div>
        <div style="font-size:12px;color:#1b5e20;line-height:1.6">
          Model oblicza miesiƒôczny abonament EaaS aby zapewniƒá ESCO docelowƒÖ stopƒô zwrotu (IRR).<br>
          <strong>Uwzglƒôdnia:</strong> CAPEX, OPEX, podatki, amortyzacjƒô, finansowanie d≈Çu≈ºne, degradacjƒô i indeksacjƒô CPI.<br>
          <strong>Wynik:</strong> Project IRR (przed d≈Çugiem) i Equity IRR (po d≈Çugu) + szczeg√≥≈Çowe przep≈Çywy miesiƒôczne.
        </div>
      </div>

      <!-- Subsection: Contract Basics -->
      <div style="margin-bottom:20px;padding:15px;background:#f5f5f5;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #4caf50;padding-bottom:6px">
          üìù Podstawowe parametry kontraktu
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Waluta kontraktu</label>
            <select id="eaasCurrency" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="PLN">PLN (Z≈Çoty Polski)</option>
              <option value="EUR">EUR (Euro)</option>
            </select>
            <span class="setting-hint">Waluta rozlicze≈Ñ EaaS</span>
          </div>

          <div class="setting-item">
            <label>IRR Driver</label>
            <select id="irrDriver" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="PLN">PLN - optymalizuj IRR w PLN</option>
              <option value="EUR">EUR - optymalizuj IRR w EUR</option>
            </select>
            <span class="setting-hint">Waluta do optymalizacji IRR</span>
          </div>

          <div class="setting-item">
            <label>Okres umowy EaaS [lat]</label>
            <input type="number" id="eaasDuration" value="10" step="1" min="5" max="25">
            <span class="setting-hint">D≈Çugo≈õƒá kontraktu subskrypcyjnego</span>
          </div>

          <div class="setting-item">
            <label>Okres ≈ºycia projektu [lat]</label>
            <input type="number" id="projectLifetime" value="25" step="1" min="15" max="35">
            <span class="setting-hint">Ca≈Çkowity okres eksploatacji PV</span>
          </div>

          <div class="setting-item">
            <label>Typ abonamentu</label>
            <select id="eaasIndexation" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="fixed">Fixed (sta≈Ça rata nominalna)</option>
              <option value="cpi">CPI (indeksacja inflacjƒÖ)</option>
            </select>
            <span class="setting-hint">Czy abonament ro≈õnie z inflacjƒÖ</span>
          </div>

          <div class="setting-item">
            <label>Docelowe IRR - PLN [%]</label>
            <input type="number" id="eaasTargetIrrPln" value="12.0" step="0.5" min="5" max="30">
            <span class="setting-hint">Target IRR dla kontrakt√≥w PLN</span>
          </div>

          <div class="setting-item">
            <label>Docelowe IRR - EUR [%]</label>
            <input type="number" id="eaasTargetIrrEur" value="10.0" step="0.5" min="5" max="25">
            <span class="setting-hint">Target IRR dla kontrakt√≥w EUR</span>
          </div>

          <div class="setting-item">
            <label>Kurs PLN/EUR</label>
            <input type="number" id="fxPlnEur" value="4.5" step="0.01" min="3" max="6">
            <span class="setting-hint">Kurs wymiany walut</span>
          </div>
        </div>
      </div>

      <!-- Subsection: Tax & Depreciation -->
      <div style="margin-bottom:20px;padding:15px;background:#fff8e1;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #ffc107;padding-bottom:6px">
          üèõÔ∏è Podatki i amortyzacja
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Stawka CIT [%]</label>
            <input type="number" id="citRate" value="19.0" step="1" min="0" max="40">
            <span class="setting-hint">Podatek dochodowy CIT (19% w PL)</span>
          </div>

          <div class="setting-item">
            <label>Metoda amortyzacji</label>
            <select id="depreciationMethod" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="linear">Liniowa</option>
              <option value="degressive">Degresywna</option>
            </select>
            <span class="setting-hint">Spos√≥b naliczania amortyzacji</span>
          </div>

          <div class="setting-item">
            <label>Okres amortyzacji [lat]</label>
            <input type="number" id="depreciationPeriod" value="20" step="1" min="5" max="30">
            <span class="setting-hint">Roczna amortyzacja = CAPEX / okres</span>
          </div>
        </div>
      </div>

      <!-- Subsection: Financing -->
      <div style="margin-bottom:20px;padding:15px;background:#e3f2fd;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #2196f3;padding-bottom:6px">
          üè¶ Finansowanie (d≈Çug)
        </div>
        <div style="margin-bottom:12px;padding:10px;background:#bbdefb;border-radius:6px;font-size:12px;color:#1565c0">
          <strong>üí° Uwaga:</strong> Leverage = 0% oznacza finansowanie 100% z equity. Zwiƒôkszenie leverage zmniejsza Equity IRR ale zwiƒôksza ROE.
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Leverage [%]</label>
            <input type="number" id="leverageRatio" value="0" step="5" min="0" max="80">
            <span class="setting-hint">% CAPEX finansowany d≈Çugiem (0-80%)</span>
          </div>

          <div class="setting-item">
            <label>Koszt d≈Çugu [%/rok]</label>
            <input type="number" id="costOfDebt" value="7.0" step="0.25" min="2" max="15">
            <span class="setting-hint">Nominalna stopa procentowa</span>
          </div>

          <div class="setting-item">
            <label>Okres kredytu [lat]</label>
            <input type="number" id="debtTenor" value="8" step="1" min="3" max="20">
            <span class="setting-hint">Tenor kredytu</span>
          </div>

          <div class="setting-item">
            <label>Karencja [lat]</label>
            <input type="number" id="debtGracePeriod" value="0" step="1" min="0" max="3">
            <span class="setting-hint">Okres sp≈Çaty tylko odsetek</span>
          </div>

          <div class="setting-item">
            <label>Typ sp≈Çaty</label>
            <select id="debtAmortization" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="annuity">Annuitetowa (r√≥wne raty)</option>
              <option value="linear">Liniowa (malejƒÖce raty)</option>
            </select>
            <span class="setting-hint">Profil sp≈Çaty kapita≈Çu</span>
          </div>
        </div>
      </div>

      <!-- Subsection: CPI Indexation -->
      <div style="margin-bottom:20px;padding:15px;background:#fce4ec;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #e91e63;padding-bottom:6px">
          üìà Indeksacja CPI
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>CPI PLN [%/rok]</label>
            <input type="number" id="cpiPln" value="2.5" step="0.1" min="0" max="15">
            <span class="setting-hint">Za≈Ço≈ºona inflacja PLN</span>
          </div>

          <div class="setting-item">
            <label>CPI EUR [%/rok]</label>
            <input type="number" id="cpiEur" value="2.0" step="0.1" min="0" max="10">
            <span class="setting-hint">Za≈Ço≈ºona inflacja EUR</span>
          </div>

          <div class="setting-item">
            <label>Czƒôstotliwo≈õƒá</label>
            <select id="indexationFrequency" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
              <option value="annual">Roczna</option>
              <option value="quarterly">Kwartalna</option>
            </select>
            <span class="setting-hint">Jak czƒôsto indeksowaƒá</span>
          </div>

          <div class="setting-item">
            <label>CPI Floor [%]</label>
            <input type="number" id="cpiFloor" value="0" step="0.5" min="-5" max="5">
            <span class="setting-hint">Minimalna indeksacja (np. 0%)</span>
          </div>

          <div class="setting-item">
            <label>CPI Cap roczny [%]</label>
            <input type="number" id="cpiCapAnnual" value="5.0" step="0.5" min="0" max="20">
            <span class="setting-hint">Max indeksacja w jednym roku</span>
          </div>

          <div class="setting-item">
            <label>CPI Cap ca≈Çkowity [%]</label>
            <input type="number" id="cpiCapTotal" value="50.0" step="5" min="0" max="100">
            <span class="setting-hint">Max skumulowana indeksacja</span>
          </div>
        </div>
      </div>

      <!-- Subsection: Technical & Risk -->
      <div style="margin-bottom:20px;padding:15px;background:#f3e5f5;border-radius:8px">
        <div style="font-weight:600;color:#333;margin-bottom:12px;border-bottom:2px solid #9c27b0;padding-bottom:6px">
          ‚öôÔ∏è Parametry techniczne i ryzyko
        </div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Dostƒôpno≈õƒá instalacji [%]</label>
            <input type="number" id="availabilityFactor" value="98.0" step="0.5" min="90" max="100">
            <span class="setting-hint">Uwzglƒôdnia awarie i przestoje</span>
          </div>

          <div class="setting-item">
            <label>Margines 0-export [%]</label>
            <input type="number" id="zeroExportMargin" value="0" step="1" min="0" max="20">
            <span class="setting-hint">Bezpiecznik przed przekroczeniem</span>
          </div>

          <div class="setting-item">
            <label>Expected Loss Rate [%]</label>
            <input type="number" id="expectedLossRate" value="0" step="0.5" min="0" max="10">
            <span class="setting-hint">Ryzyko kredytowe klienta</span>
          </div>
        </div>
      </div>

      <div style="padding:12px;background:#e8f5e9;border-radius:8px;border-left:3px solid #4caf50">
        <div style="font-size:12px;color:#2e7d32">
          <strong>üìä Model generuje:</strong><br>
          ‚Ä¢ Miesiƒôczne przep≈Çywy pieniƒô≈ºne (CF) przez ca≈Çy okres projektu<br>
          ‚Ä¢ Project IRR (przed finansowaniem) i Equity IRR (po finansowaniu)<br>
          ‚Ä¢ EBITDA, EBIT, podatek CIT z tarczƒÖ amortyzacyjnƒÖ<br>
          ‚Ä¢ Obs≈Çugƒô d≈Çugu (odsetki + kapita≈Ç) je≈õli leverage > 0<br>
          ‚Ä¢ Warto≈õƒá rezydualnƒÖ po zako≈Ñczeniu kontraktu<br>
          ‚Ä¢ Cenƒô EaaS per MWh i por√≥wnanie do ceny z sieci
        </div>
      </div>
    </div>

    <!-- Weather Data Source & Production Scenarios -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">üå§Ô∏è</span>
        <h2>≈πr√≥d≈Ço Danych Meteorologicznych</h2>
        <span class="section-info">Dane pogodowe i scenariusze produkcji PV</span>
      </div>

      <div class="setting-item" style="max-width:600px;margin-bottom:20px">
        <label>≈πr√≥d≈Ço danych pogodowych</label>
        <select id="weatherDataSource" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
          <option value="pvgis">PVGIS (Rekomendowane) - Dane TMY z EU</option>
          <option value="clearsky">Clearsky Model - Symulacja bezchmurnego nieba</option>
        </select>
        <span class="setting-hint">PVGIS: Rzeczywiste dane meteorologiczne dla Europy (dok≈Çadniejsze). Clearsky: Model teoretyczny (szybszy, mniej dok≈Çadny)</span>
      </div>

      <!-- Production Scenarios (P-factors) -->
      <div style="margin-top:24px;padding:20px;background:#e8eaf6;border-radius:8px;border-left:4px solid #3f51b5">
        <div style="font-weight:600;color:#1a237e;margin-bottom:12px;font-size:15px">
          üìä Scenariusze produkcji (P-factors)
        </div>
        <div style="margin-bottom:16px;padding:12px;background:#c5cae9;border-radius:6px;font-size:12px;color:#283593;line-height:1.5">
          Scenariusze P50/P75/P90 s≈Çu≈ºƒÖ do modelowania niepewno≈õci produkcji energii.<br>
          <strong>P50</strong> = scenariusz bazowy (mediana), <strong>P75</strong> i <strong>P90</strong> = coraz bardziej ostro≈ºne warianty ‚Äì z odpowiednio 25% i 10% szansƒÖ na ni≈ºszƒÖ produkcjƒô.
        </div>

        <!-- Source Selection -->
        <div class="setting-item" style="margin-bottom:16px">
          <label style="font-weight:600;color:#3f51b5">≈πr√≥d≈Ço mno≈ºnik√≥w Pxx</label>
          <select id="pxxSource" onchange="togglePxxSourceFields()" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
            <option value="manual">Manualne (sta≈Çe warto≈õci 100/97/94%)</option>
            <option value="pvgis_uncertainty">PVGIS Uncertainty (szybkie - PVcalc)</option>
            <option value="pvgis_timeseries">PVGIS Timeseries (dok≈Çadne - seriescalc)</option>
          </select>
        </div>

        <!-- Method descriptions -->
        <div id="pxxMethodDescription" style="margin-bottom:16px;padding:10px;background:#fff;border-radius:6px;font-size:11px;color:#555;line-height:1.5">
          <strong>PVGIS Uncertainty (szybkie)</strong> - Liczy P50/P75/P90 na podstawie ≈õredniej rocznej produkcji i niepewno≈õci modelu PVGIS. Idealne do codziennych symulacji.<br>
          <strong>PVGIS Timeseries (dok≈Çadne)</strong> - Pobiera wieloletniƒÖ seriƒô godzinowƒÖ z PVGIS i liczy P50/P75/P90 z rzeczywistego rozk≈Çadu rocznej produkcji. Do analiz inwestorskich.
        </div>

        <!-- Manual Factors (shown when pxxSource = 'manual') -->
        <div id="pxxManualSection">
          <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:#3f51b5">Mno≈ºniki manualne:</div>
          <div class="settings-grid">
            <div class="setting-item">
              <label>P50 Factor</label>
              <input type="number" id="productionP50Factor" value="1.00" step="0.01" min="0.80" max="1.10">
              <span class="setting-hint">100% = mediana produkcji</span>
            </div>
            <div class="setting-item">
              <label>P75 Factor</label>
              <input type="number" id="productionP75Factor" value="0.97" step="0.01" min="0.80" max="1.05">
              <span class="setting-hint">97% = konserwatywny</span>
            </div>
            <div class="setting-item">
              <label>P90 Factor</label>
              <input type="number" id="productionP90Factor" value="0.94" step="0.01" min="0.80" max="1.00">
              <span class="setting-hint">94% = bardzo konserwatywny</span>
            </div>
          </div>
        </div>

        <!-- PVGIS Settings (shown when pxxSource != 'manual') -->
        <div id="pxxPvgisSection" style="display:none">
          <!-- Uncertainty Parameters -->
          <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:#3f51b5">Parametry niepewno≈õci:</div>
          <div class="settings-grid" style="margin-bottom:16px">
            <div class="setting-item">
              <label>Niepewno≈õƒá modelu [%]</label>
              <input type="number" id="pxxModelUncertaintyPct" value="3" step="0.5" min="0" max="10">
              <span class="setting-hint">B≈ÇƒÖd PR, invertera itp.</span>
            </div>
            <div class="setting-item">
              <label>Inne niepewno≈õci [%]</label>
              <input type="number" id="pxxOtherUncertaintyPct" value="2" step="0.5" min="0" max="10">
              <span class="setting-hint">Soiling, konstrukcja itp.</span>
            </div>
          </div>

          <!-- PVGIS Configuration -->
          <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:#3f51b5">Konfiguracja PVGIS:</div>
          <div class="settings-grid">
            <div class="setting-item">
              <label>Baza danych radiacji</label>
              <select id="pvgisRadDatabase" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                <option value="PVGIS-SARAH3">PVGIS-SARAH3 (Europa, najnowsza)</option>
                <option value="PVGIS-SARAH2">PVGIS-SARAH2 (Europa)</option>
                <option value="PVGIS-ERA5">PVGIS-ERA5 (globalnie)</option>
              </select>
              <span class="setting-hint">≈πr√≥d≈Ço danych nas≈Çonecznienia</span>
            </div>
            <div class="setting-item">
              <label>Straty systemowe [%]</label>
              <input type="number" id="pvgisLossPct" value="14" step="1" min="5" max="25">
              <span class="setting-hint">Sumaryczne straty PV</span>
            </div>
            <div class="setting-item">
              <label>Technologia PV</label>
              <select id="pvgisPvTechChoice" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                <option value="crystSi">Krzemowy krystaliczny</option>
                <option value="CIS">CIS</option>
                <option value="CdTe">CdTe</option>
              </select>
              <span class="setting-hint">Typ modu≈Ç√≥w PV</span>
            </div>
            <div class="setting-item">
              <label>Typ monta≈ºu</label>
              <select id="pvgisMountingPlace" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px">
                <option value="free">WolnostojƒÖce (grunt)</option>
                <option value="building">Dach budynku</option>
              </select>
              <span class="setting-hint">Wp≈Çywa na ch≈Çodzenie modu≈Ç√≥w</span>
            </div>
          </div>

          <!-- Timeseries-specific settings -->
          <div id="pxxTimeseriesSettings" style="margin-top:16px;display:none">
            <div style="margin-bottom:8px;font-size:12px;font-weight:600;color:#3f51b5">Zakres lat (timeseries):</div>
            <div class="settings-grid">
              <div class="setting-item">
                <label>Rok poczƒÖtkowy</label>
                <input type="number" id="pvgisStartYear" value="2005" step="1" min="2005" max="2020">
                <span class="setting-hint">Min. 10 lat zakresu</span>
              </div>
              <div class="setting-item">
                <label>Rok ko≈Ñcowy</label>
                <input type="number" id="pvgisEndYear" value="2020" step="1" min="2015" max="2023">
                <span class="setting-hint">Ostatnie dostƒôpne dane</span>
              </div>
            </div>
          </div>

          <!-- Calculated Pxx Display -->
          <div id="pxxCalculatedDisplay" style="margin-top:16px;padding:12px;background:#e8f5e9;border-radius:6px;display:none">
            <div style="font-size:12px;font-weight:600;color:#2e7d32;margin-bottom:8px">üìä Wyliczone mno≈ºniki Pxx:</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center">
              <div>
                <div style="font-size:11px;color:#666">P50</div>
                <div id="pxxCalcP50" style="font-size:18px;font-weight:700;color:#27ae60">100.0%</div>
              </div>
              <div>
                <div style="font-size:11px;color:#666">P75</div>
                <div id="pxxCalcP75" style="font-size:18px;font-weight:700;color:#3498db">‚Äì</div>
              </div>
              <div>
                <div style="font-size:11px;color:#666">P90</div>
                <div id="pxxCalcP90" style="font-size:18px;font-weight:700;color:#e74c3c">‚Äì</div>
              </div>
            </div>
            <div id="pxxCalcInfo" style="margin-top:8px;font-size:10px;color:#666;text-align:center"></div>
          </div>

          <!-- Fetch Button -->
          <div style="margin-top:16px;text-align:center">
            <button onclick="fetchPxxFromPVGIS()" class="btn btn-primary" style="padding:10px 24px">
              üîÑ Pobierz Pxx z PVGIS
            </button>
            <div id="pxxFetchStatus" style="margin-top:8px;font-size:11px;color:#666"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- PV Installation Defaults - per type -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">‚òÄÔ∏è</span>
        <h2>Parametry Instalacji PV</h2>
        <span class="setting-info">Uzysk i szeroko≈õƒá geograficzna dla ka≈ºdego typu</span>
      </div>

      <!-- Ground South -->
      <div class="pv-type-section" style="margin-bottom:20px;padding:15px;background:#e8f5e9;border-radius:8px;border-left:4px solid #4caf50">
        <div style="font-weight:600;color:#2e7d32;margin-bottom:10px">üåç Grunt Po≈Çudnie</div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Uzysk [kWh/kWp/rok]</label>
            <input type="number" id="pvYield_ground_s" value="1050" step="10">
          </div>
          <div class="setting-item">
            <label>Szeroko≈õƒá geogr. [¬∞]</label>
            <input type="number" id="latitude_ground_s" value="52.0" step="0.1" min="49" max="55">
          </div>
          <div class="setting-item">
            <label>KƒÖt nachylenia [¬∞]</label>
            <input type="number" id="tilt_ground_s" value="0" step="1" min="0" max="90">
            <span class="setting-hint">0 = auto (szeroko≈õƒá geogr.)</span>
          </div>
          <div class="setting-item">
            <label>Azymut [¬∞]</label>
            <input type="number" id="azimuth_ground_s" value="180" step="5" min="0" max="360">
            <span class="setting-hint">180¬∞ = Po≈Çudnie</span>
          </div>
        </div>
      </div>

      <!-- Roof East-West -->
      <div class="pv-type-section" style="margin-bottom:20px;padding:15px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
        <div style="font-weight:600;color:#1565c0;margin-bottom:10px">üè† Dach Wsch√≥d-Zach√≥d</div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Uzysk [kWh/kWp/rok]</label>
            <input type="number" id="pvYield_roof_ew" value="950" step="10">
          </div>
          <div class="setting-item">
            <label>Szeroko≈õƒá geogr. [¬∞]</label>
            <input type="number" id="latitude_roof_ew" value="52.0" step="0.1" min="49" max="55">
          </div>
          <div class="setting-item">
            <label>KƒÖt nachylenia [¬∞]</label>
            <input type="number" id="tilt_roof_ew" value="10" step="1" min="0" max="90">
            <span class="setting-hint">Niski kƒÖt dla E-W</span>
          </div>
          <div class="setting-item">
            <label>Azymut E/W [¬∞]</label>
            <input type="number" id="azimuth_roof_ew" value="90" step="5" min="0" max="360">
            <span class="setting-hint">90¬∞=E, 270¬∞=W</span>
          </div>
        </div>
      </div>

      <!-- Ground East-West -->
      <div class="pv-type-section" style="padding:15px;background:#fff3e0;border-radius:8px;border-left:4px solid #ff9800">
        <div style="font-weight:600;color:#e65100;margin-bottom:10px">üåç Grunt Wsch√≥d-Zach√≥d</div>
        <div class="settings-grid">
          <div class="setting-item">
            <label>Uzysk [kWh/kWp/rok]</label>
            <input type="number" id="pvYield_ground_ew" value="980" step="10">
          </div>
          <div class="setting-item">
            <label>Szeroko≈õƒá geogr. [¬∞]</label>
            <input type="number" id="latitude_ground_ew" value="52.0" step="0.1" min="49" max="55">
          </div>
          <div class="setting-item">
            <label>KƒÖt nachylenia [¬∞]</label>
            <input type="number" id="tilt_ground_ew" value="15" step="1" min="0" max="90">
            <span class="setting-hint">KƒÖt dla E-W grunt</span>
          </div>
          <div class="setting-item">
            <label>Azymut E/W [¬∞]</label>
            <input type="number" id="azimuth_ground_ew" value="90" step="5" min="0" max="360">
            <span class="setting-hint">90¬∞=E, 270¬∞=W</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Environmental Parameters -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">üåç</span>
        <h2>Parametry ≈örodowiskowe (Zaawansowane)</h2>
        <span class="section-info">Dodatkowe parametry wp≈ÇywajƒÖce na dok≈Çadno≈õƒá symulacji</span>
      </div>

      <div class="settings-grid">
        <div class="setting-item">
          <label>Wysoko≈õƒá npm [m]</label>
          <input type="number" id="altitude" value="100" step="10" min="0" max="2500">
          <span class="setting-hint">Wysoko≈õƒá instalacji nad poziomem morza</span>
        </div>
        <div class="setting-item">
          <label>Albedo (reflektancja gruntu)</label>
          <input type="number" id="albedo" value="0.2" step="0.05" min="0.1" max="0.9">
          <span class="setting-hint">0.2=trawa, 0.3=beton, 0.8=≈õnieg</span>
        </div>
        <div class="setting-item">
          <label>Straty przez zabrudzenie [%]</label>
          <input type="number" id="soilingLoss" value="2" step="0.5" min="0" max="10">
          <span class="setting-hint">Typowo 2-3% dla Europy</span>
        </div>
      </div>

      <div style="margin-top:16px;padding:12px;background:#fff3e0;border-radius:8px;border-left:3px solid #ff9800">
        <div style="font-size:12px;color:#e65100">
          <strong>üí° Wyja≈õnienia:</strong><br>
          <strong>Wysoko≈õƒá npm:</strong> Wy≈ºsza wysoko≈õƒá = wy≈ºsza irradiancja (cie≈Ñsza atmosfera)<br>
          <strong>Albedo:</strong> Reflektancja gruntu wp≈Çywa na odbite promieniowanie. Wy≈ºsze albedo = wiƒôcej odbicia = wy≈ºsza produkcja<br>
          <strong>Soiling loss:</strong> Straty przez zabrudzenie paneli (kurz, py≈Ç, li≈õcie). Zale≈ºy od regionu i czƒôstotliwo≈õci czyszczenia
        </div>
      </div>
    </div>

    <!-- DC/AC Ratio Tiers -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">‚ö°</span>
        <h2>DC/AC Ratio wg wielko≈õci instalacji</h2>
        <span class="section-info">Wsp√≥≈Çczynnik DC/AC dla ka≈ºdego przedzia≈Çu mocy i typu monta≈ºu</span>
      </div>

      <!-- Info Box -->
      <div style="margin-bottom:16px;padding:12px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
        <div style="font-size:12px;color:#1565c0;line-height:1.5">
          <strong>üí° DC/AC Ratio (Oversizing)</strong> to stosunek mocy DC paneli do mocy AC falownika.<br>
          Wy≈ºsze ratio (np. 1.4) = wiƒôcej paneli na falownik = wiƒôcej energii rano/wieczorem, ale curtailment w szczycie.<br>
          <strong>Grunt P≈Çd</strong> = panele na po≈Çudnie (najwy≈ºsza produkcja w szczycie) ‚Üí ni≈ºsze ratio.<br>
          <strong>Dach/Grunt E-W</strong> = panele wsch√≥d-zach√≥d (rozproszona produkcja) ‚Üí wy≈ºsze ratio.
        </div>
      </div>

      <!-- Slider korekty DC/AC -->
      <div style="margin-bottom:20px;padding:16px;background:#fff8e1;border-radius:8px;border-left:4px solid #ffc107">
        <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap">
          <div style="flex:1;min-width:200px">
            <label style="font-weight:600;color:#f57c00;display:block;margin-bottom:8px">
              üéöÔ∏è Korekta DC/AC (dla zaawansowanych)
            </label>
            <div style="display:flex;align-items:center;gap:12px">
              <span style="font-size:12px;color:#666">-0.10</span>
              <input type="range" id="dcacAdjustment"
                     min="-0.10" max="0.10" step="0.01" value="0"
                     style="flex:1;cursor:pointer"
                     oninput="updateDcacSlider(this.value)">
              <span style="font-size:12px;color:#666">+0.10</span>
            </div>
          </div>
          <div style="text-align:center;min-width:80px">
            <div style="font-size:11px;color:#666;margin-bottom:4px">Korekta</div>
            <div id="dcacAdjustmentDisplay" style="font-size:24px;font-weight:700;color:#666">0.00</div>
          </div>
        </div>
        <div style="margin-top:8px;font-size:11px;color:#795548">
          Przesu≈Ñ w lewo (-) je≈õli masz curtailment/ograniczenia sieciowe. Przesu≈Ñ w prawo (+) je≈õli masz niskƒÖ cenƒô modu≈Ç√≥w lub PPA z p≈ÇaskƒÖ cenƒÖ.
        </div>
      </div>

      <!-- Dynamic DC/AC Tiers Table Container -->
      <div id="dcac_tiers_container">
        <!-- Tabela bƒôdzie renderowana dynamicznie przez JavaScript -->
      </div>
    </div>

    <!-- Analysis Range -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">üîç</span>
        <h2>Zakres Analizy</h2>
        <span class="section-info">Przedzia≈Çy mocy do analizy</span>
      </div>
      <div class="settings-grid">
        <div class="setting-item">
          <label>Moc minimalna [kWp]</label>
          <input type="number" id="capMin" value="1000" step="100">
        </div>
        <div class="setting-item">
          <label>Moc maksymalna [kWp]</label>
          <input type="number" id="capMax" value="50000" step="1000">
        </div>
        <div class="setting-item">
          <label>Krok [kWp]</label>
          <input type="number" id="capStep" value="500" step="100">
        </div>
      </div>
    </div>

    <!-- Optimization Thresholds -->
    <div class="settings-section">
      <div class="section-header">
        <span class="section-icon">üéØ</span>
        <h2>Progi Autokonsumpcji</h2>
        <span class="section-info">Warianty A, B, C, D [%]</span>
      </div>
      <div class="settings-grid threshold-grid">
        <div class="setting-item threshold-a">
          <label>Wariant A</label>
          <input type="number" id="thrA" value="95" min="50" max="100">
          <span class="setting-hint">Najwy≈ºsza autokonsumpcja</span>
        </div>
        <div class="setting-item threshold-b">
          <label>Wariant B</label>
          <input type="number" id="thrB" value="90" min="50" max="100">
        </div>
        <div class="setting-item threshold-c">
          <label>Wariant C</label>
          <input type="number" id="thrC" value="85" min="50" max="100">
        </div>
        <div class="setting-item threshold-d">
          <label>Wariant D</label>
          <input type="number" id="thrD" value="80" min="50" max="100">
          <span class="setting-hint">Najni≈ºsza autokonsumpcja</span>
        </div>
      </div>
    </div>

  </div>

  <div class="settings-footer">
    <button class="btn btn-primary" onclick="saveAllSettings()">üíæ ZAPISZ USTAWIENIA</button>
    <button class="btn btn-secondary" onclick="resetToDefaults()">üîÑ PRZYWR√ìƒÜ DOMY≈öLNE</button>
    <button class="btn btn-export" onclick="exportSettings()">üì• EKSPORT</button>
    <button class="btn btn-import" onclick="importSettings()">üì§ IMPORT</button>
    <input type="file" id="importFile" accept=".json" style="display:none" onchange="handleImport(event)">
  </div>

  <div id="saveStatus" class="save-status"></div>
</div>

<script>
// Password protection for EaaS section
function unlockEaasSection() {
  const password = prompt('Wprowad≈∫ has≈Ço aby odblokowaƒá parametry EaaS:');

  // Check password (change 'admin123' to your desired password)
  if (password === 'admin123') {
    document.getElementById('eaasPasswordSection').style.display = 'none';
    document.getElementById('eaasParamsSection').style.display = 'block';

    // Show success message
    const saveStatus = document.getElementById('saveStatus');
    saveStatus.textContent = '‚úÖ Parametry EaaS odblokowane';
    saveStatus.className = 'save-status success';
    setTimeout(() => {
      saveStatus.className = 'save-status';
    }, 3000);
  } else if (password !== null) {
    alert('‚ùå Nieprawid≈Çowe has≈Ço!');
  }
}
</script>

<script src="settings.js"></script>
</body>
</html>
