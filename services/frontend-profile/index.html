<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analiza Profilu PV+BESS v2.0</title>
    <link rel="stylesheet" href="profile.css?v=20251212-PEAK-ARBITRAGE">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üìä Analiza Profilu PV + BESS v2.0</h1>
            <p>Optymalizacja multi-obiektywowa z integracjƒÖ PyPSA</p>
        </header>

        <div id="errorMessage"></div>

        <!-- Configuration Panel -->
        <section class="config-panel">
            <h2>Parametry analizy</h2>
            <div class="config-grid">
                <div class="form-group">
                    <label for="pvCapacity">Moc PV [kWp]</label>
                    <input type="number" id="pvCapacity" value="1200" min="10" step="10">
                </div>
                <div class="form-group">
                    <label for="bessEnergy">Pojemno≈õƒá BESS [kWh]</label>
                    <input type="number" id="bessEnergy" value="2000" min="0" step="100">
                </div>
                <div class="form-group">
                    <label for="bessPower">Moc BESS [kW]</label>
                    <input type="number" id="bessPower" value="500" min="0" step="50">
                </div>
                <div class="form-group">
                    <label for="bessEfficiency">Sprawno≈õƒá BESS [%]</label>
                    <input type="number" id="bessEfficiency" value="90" min="70" max="98" step="1">
                </div>
                <div class="form-group">
                    <label for="energyPrice">Cena energii [PLN/MWh]</label>
                    <input type="number" id="energyPrice" value="800" min="100" step="50">
                </div>
                <div class="form-group">
                    <label for="bessCapexKwh">CAPEX BESS [PLN/kWh]</label>
                    <input type="number" id="bessCapexKwh" value="1500" min="500" step="100">
                </div>
                <div class="form-group">
                    <label for="bessCapexKw">CAPEX BESS [PLN/kW]</label>
                    <input type="number" id="bessCapexKw" value="300" min="0" step="50">
                </div>
                <div class="form-group">
                    <label for="discountRate">Stopa dyskontowa [%]</label>
                    <input type="number" id="discountRate" value="8" min="0" max="20" step="0.5">
                </div>
                <div class="form-group">
                    <label for="projectYears">Okres analizy [lat]</label>
                    <input type="number" id="projectYears" value="15" min="5" max="25" step="1">
                </div>
                <div class="form-group">
                    <label for="strategy">Strategia optymalizacji</label>
                    <select id="strategy">
                        <option value="npv_max">NPV Max (najwiƒôkszy zwrot)</option>
                        <option value="cycles_max">Cycles Max (max cykli)</option>
                        <option value="balanced" selected>Balanced (r√≥wnowaga NPV/cykle)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="minCycles">Min. cykli rocznie</label>
                    <input type="number" id="minCycles" value="200" min="50" max="500" step="10">
                </div>
                <div class="form-group">
                    <label for="maxCycles">Max. cykli rocznie</label>
                    <input type="number" id="maxCycles" value="365" min="200" max="700" step="10">
                </div>
            </div>

            <!-- Advanced BESS Features (collapsible) -->
            <details class="advanced-features" style="margin-top: 20px;">
                <summary style="cursor:pointer;padding:12px;background:linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);border-radius:8px;font-weight:600;color:#1565c0;">
                    ‚ö° Zaawansowane funkcje BESS (Peak Shaving & Arbitra≈º)
                </summary>
                <div style="padding:16px;background:#fff;border:1px solid #e0e0e0;border-top:none;border-radius:0 0 8px 8px;">
                    <div class="config-grid">
                        <!-- Peak Shaving -->
                        <div class="form-group" style="grid-column: 1 / -1;">
                            <h4 style="margin:0 0 10px 0;color:#0277bd;">üìâ Peak Shaving <span class="tooltip-icon" data-tooltip="Redukcja szczyt√≥w mocy przez roz≈Çadowanie BESS gdy zapotrzebowanie przekracza ustalony pr√≥g. Zmniejsza op≈Çaty mocowe naliczane od maksymalnej mocy zam√≥wionej.">?</span></h4>
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:8px">
                                <input type="checkbox" id="peakShavingEnabled" style="width:18px;height:18px">
                                W≈ÇƒÖcz Peak Shaving <span class="tooltip-icon" data-tooltip="W≈ÇƒÖcz symulacjƒô peak shaving. BESS bƒôdzie rezerwowaƒá czƒô≈õƒá pojemno≈õci na pokrycie szczyt√≥w mocy zamiast pe≈Çnej autokonsumpcji.">?</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="peakShavingMode">Tryb <span class="tooltip-icon" data-tooltip="AUTO: pr√≥g = 95 percentyl zu≈ºycia (redukuje 5% najwy≈ºszych szczyt√≥w). Rƒôczny: ustaw sta≈Çy pr√≥g kW. Procentowy: redukcja o X% od max.">?</span></label>
                            <select id="peakShavingMode">
                                <option value="auto" selected>AUTO (P95)</option>
                                <option value="manual">Rƒôczny</option>
                                <option value="percentage">Procentowy</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="peakShavingTargetKw">Pr√≥g [kW] <span class="tooltip-icon" data-tooltip="W trybie rƒôcznym: sta≈Çy pr√≥g mocy. Gdy zu≈ºycie > pr√≥g, BESS roz≈Çadowuje siƒô. Przyk≈Çad: pr√≥g 800 kW, szczyt 1000 kW ‚Üí BESS dostarcza 200 kW.">?</span></label>
                            <input type="number" id="peakShavingTargetKw" value="0" min="0" step="10">
                        </div>
                        <div class="form-group">
                            <label for="powerChargePlnPerKwMonth">Op≈Çata moc. [PLN/kW/m-c] <span class="tooltip-icon" data-tooltip="Op≈Çata mocowa za 1 kW mocy zam√≥wionej/szczytowej na miesiƒÖc. W Polsce typowo 30-80 PLN/kW/m-c dla przemys≈Çu. Roczna oszczƒôdno≈õƒá = (ŒîP √ó 12 √ó op≈Çata).">?</span></label>
                            <input type="number" id="powerChargePlnPerKwMonth" value="50" min="0" step="5">
                        </div>

                        <!-- Price Arbitrage -->
                        <div class="form-group" style="grid-column: 1 / -1; margin-top: 15px;">
                            <h4 style="margin:0 0 10px 0;color:#c2185b;">üíπ Arbitra≈º Cenowy (RDN) <span class="tooltip-icon" data-tooltip="Kupuj energiƒô gdy tania, sprzedawaj gdy droga. Wykorzystuje zmienno≈õƒá cen na Rynku Dnia Nastƒôpnego. Wymaga analizy historycznych cen TGE lub w≈Çasnych prognoz.">?</span></h4>
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:8px">
                                <input type="checkbox" id="priceArbitrageEnabled" style="width:18px;height:18px">
                                W≈ÇƒÖcz Arbitra≈º <span class="tooltip-icon" data-tooltip="W≈ÇƒÖcz symulacjƒô arbitra≈ºu cenowego. BESS bƒôdzie ≈Çadowaƒá siƒô z sieci gdy cena < pr√≥g kupna i roz≈Çadowywaƒá gdy cena > pr√≥g sprzeda≈ºy.">?</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label for="arbitrageSource">≈πr√≥d≈Ço cen <span class="tooltip-icon" data-tooltip="Rƒôczne progi: ustaw sta≈Çe warto≈õci. TGE API: pobierz rzeczywiste ceny RDN (wymaga integracji). CSV: wgraj w≈Çasny plik z cenami godzinowymi.">?</span></label>
                            <select id="arbitrageSource">
                                <option value="manual" selected>Rƒôczne progi</option>
                                <option value="tge_api">TGE API</option>
                                <option value="csv_upload">Upload CSV</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="arbitrageBuyThreshold">Pr√≥g kupna [PLN/MWh] <span class="tooltip-icon" data-tooltip="BESS ≈Çaduje siƒô z sieci gdy cena < tego progu. Przyk≈Çad: 300 PLN/MWh to typowa cena nocna/weekendowa. Ni≈ºszy pr√≥g = mniej okazji ale ta≈Ñszy zakup.">?</span></label>
                            <input type="number" id="arbitrageBuyThreshold" value="300" min="0" step="10">
                        </div>
                        <div class="form-group">
                            <label for="arbitrageSellThreshold">Pr√≥g sprzeda≈ºy [PLN/MWh] <span class="tooltip-icon" data-tooltip="BESS roz≈Çadowuje do sieci gdy cena > tego progu. Przyk≈Çad: 600 PLN/MWh to typowy szczyt poranny/wieczorny. Wy≈ºszy pr√≥g = mniej okazji ale dro≈ºej sprzedasz.">?</span></label>
                            <input type="number" id="arbitrageSellThreshold" value="600" min="100" step="10">
                        </div>

                        <!-- Kraken Protocol: PyPSA Optimizer -->
                        <div class="form-group" style="grid-column: 1 / -1; margin-top: 15px;">
                            <h4 style="margin:0 0 10px 0;color:#6a1b9a;">üêô Protok√≥≈Ç Kraken (PyPSA + HiGHS) <span class="tooltip-icon" data-tooltip="U≈ºyj optymalizacji liniowej (LP) zamiast algorytmu zach≈Çannego. PyPSA + HiGHS znajduje globalnie optymalny dispatch BESS. Wolniejsze ale dok≈Çadniejsze - r√≥≈ºnica widoczna przy arbitra≈ºu cenowym.">?</span></h4>
                        </div>
                        <div class="form-group">
                            <label style="display:flex;align-items:center;gap:8px">
                                <input type="checkbox" id="usePypsaOptimizer" style="width:18px;height:18px">
                                U≈ºyj PyPSA + HiGHS <span class="tooltip-icon" data-tooltip="W≈ÇƒÖcz optymalizacjƒô LP/MIP zamiast symulacji zach≈Çannej. Greedy = szybkie przybli≈ºenie (ka≈ºda godzina osobno). PyPSA = globalna optymalizacja (wszystkie godziny jednocze≈õnie).">?</span>
                            </label>
                        </div>
                    </div>
                </div>
            </details>

            <button id="analyzeBtn" class="btn-analyze" style="margin-top: 15px;">üî¨ Analizuj profil (PyPSA)</button>
        </section>

        <!-- Results Section -->
        <section id="results">
            <!-- Tabs -->
            <div class="tabs">
                <button class="tab-btn active" data-tab="summary">Podsumowanie</button>
                <button class="tab-btn" data-tab="pareto">Pareto Front</button>
                <button class="tab-btn" data-tab="heatmap">Heatmapa</button>
                <button class="tab-btn" data-tab="variants">Por√≥wnanie wariant√≥w</button>
                <button class="tab-btn" data-tab="hourly">Profil godzinowy</button>
                <button class="tab-btn" data-tab="monthly">Analiza miesiƒôczna</button>
                <button class="tab-btn" data-tab="quarterly">Kwarta≈Çy</button>
                <button class="tab-btn" data-tab="peakShaving">üìâ Peak Shaving</button>
                <button class="tab-btn" data-tab="bessRec">Rekomendacje BESS</button>
                <button class="tab-btn" data-tab="pvRec">Rekomendacje PV</button>
                <button class="tab-btn" data-tab="insights">Wnioski</button>
            </div>

            <!-- Summary Tab -->
            <div id="summaryTab" class="tab-panel active">
                <h3>Podsumowanie roczne</h3>
                <div id="summaryContent"></div>
                <div id="selectedStrategy" class="strategy-badge"></div>
            </div>

            <!-- Pareto Front Tab -->
            <div id="paretoTab" class="tab-panel">
                <h3>Pareto Front: NPV vs Cykle</h3>
                <p class="description">Punkty Pareto-optymalne - ka≈ºdy jest optymalny dla r√≥≈ºnego kompromisu miƒôdzy NPV a liczbƒÖ cykli</p>
                <div class="chart-container pareto-chart">
                    <canvas id="paretoChart"></canvas>
                </div>
                <div id="paretoTable" class="pareto-table-container"></div>
            </div>

            <!-- Heatmap Tab -->
            <div id="heatmapTab" class="tab-panel">
                <h3>Heatmapa surplus/deficit</h3>
                <p class="description">Rozk≈Çad nadwy≈ºek i deficyt√≥w: 24 godziny √ó 12 miesiƒôcy</p>
                <div id="heatmapContainer" class="heatmap-container"></div>
                <div class="heatmap-legend">
                    <span class="legend-deficit">‚Üê Deficyt</span>
                    <span class="legend-neutral">Bilans</span>
                    <span class="legend-surplus">Nadwy≈ºka ‚Üí</span>
                </div>
            </div>

            <!-- Variants Comparison Tab -->
            <div id="variantsTab" class="tab-panel">
                <h3>Por√≥wnanie wariant√≥w</h3>
                <p class="description">Side-by-side por√≥wnanie: Bez BESS vs Rekomendowany BESS</p>
                <div id="variantsContent" class="variants-grid"></div>
            </div>

            <!-- Hourly Tab -->
            <div id="hourlyTab" class="tab-panel">
                <h3>≈öredni profil godzinowy</h3>
                <p class="description">≈örednie warto≈õci dla ka≈ºdej godziny w ciƒÖgu roku</p>
                <div class="chart-container">
                    <canvas id="hourlyChart"></canvas>
                </div>
            </div>

            <!-- Monthly Tab -->
            <div id="monthlyTab" class="tab-panel">
                <h3>Analiza miesiƒôczna</h3>
                <div class="chart-container">
                    <canvas id="monthlyChart"></canvas>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>MiesiƒÖc</th>
                                <th>PV<br>[MWh]</th>
                                <th>Zu≈ºycie<br>[MWh]</th>
                                <th>Nadwy≈ºka<br>[MWh]</th>
                                <th>Deficyt<br>[MWh]</th>
                                <th>≈ör. nadwy≈ºka<br>[kWh/d]</th>
                                <th>Godzin<br>nadwy≈ºki/d</th>
                                <th>Opt. BESS<br>[kWh]</th>
                                <th>Cykle<br>BESS</th>
                                <th>Eksport</th>
                            </tr>
                        </thead>
                        <tbody id="monthlyTableBody">
                        </tbody>
                    </table>
                </div>

                <!-- Export Section -->
                <div class="export-section" style="margin-top: 20px; padding: 15px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 8px; border: 1px solid #64b5f6;">
                    <h4 style="margin: 0 0 10px 0; color: #1565c0;">üì• Eksport szczeg√≥≈Çowych danych godzinowych</h4>
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <label style="font-weight: 500;">Wybierz miesiƒÖc:</label>
                        <select id="exportMonthSelect" style="padding: 8px 12px; border-radius: 4px; border: 1px solid #64b5f6; font-size: 14px; min-width: 150px;">
                            <option value="0">üìÖ Ca≈Çy rok (wszystkie miesiƒÖce)</option>
                            <option value="1">Stycze≈Ñ</option>
                            <option value="2">Luty</option>
                            <option value="3">Marzec</option>
                            <option value="4">Kwiecie≈Ñ</option>
                            <option value="5" selected>Maj</option>
                            <option value="6">Czerwiec</option>
                            <option value="7">Lipiec</option>
                            <option value="8">Sierpie≈Ñ</option>
                            <option value="9">Wrzesie≈Ñ</option>
                            <option value="10">Pa≈∫dziernik</option>
                            <option value="11">Listopad</option>
                            <option value="12">Grudzie≈Ñ</option>
                        </select>
                        <button id="exportMonthBtn" onclick="exportMonthlyHourlyData()" style="padding: 10px 20px; background: #1976d2; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px;">
                            üìä Eksportuj do Excel
                        </button>
                        <span id="exportInfo" style="color: #666; font-size: 12px;">Zawiera: Load, PV, Nadwy≈ºka, ≈Åadowanie BESS, Roz≈Çadowanie BESS</span>
                    </div>
                </div>
            </div>

            <!-- Quarterly Tab -->
            <div id="quarterlyTab" class="tab-panel">
                <h3>Rozk≈Çad kwartalny</h3>
                <p class="description">Por√≥wnanie aktywno≈õci BESS w poszczeg√≥lnych kwarta≈Çach</p>
                <div id="quarterlyContent"></div>
            </div>

            <!-- Peak Shaving Tab -->
            <div id="peakShavingTab" class="tab-panel">
                <h3>üìâ Analiza Peak Shaving</h3>
                <p class="description">Redukcja szczyt√≥w mocy i oszczƒôdno≈õci na op≈Çatach mocowych</p>

                <div id="peakShavingDisabled" style="display:none; padding: 30px; text-align: center; background: #f5f5f5; border-radius: 8px; margin: 20px 0;">
                    <p style="font-size: 1.1rem; color: #666;">‚ö†Ô∏è Peak Shaving jest wy≈ÇƒÖczony</p>
                    <p style="color: #888;">W≈ÇƒÖcz funkcjƒô w sekcji "Zaawansowane funkcje BESS" powy≈ºej i uruchom analizƒô ponownie.</p>
                </div>

                <div id="peakShavingResults" style="display:none;">
                    <!-- Summary Cards -->
                    <div class="summary-grid" style="margin-bottom: 25px;">
                        <div class="summary-card">
                            <div class="summary-label">Moc szczytowa PRZED</div>
                            <div class="summary-value" id="psPeakBefore">-</div>
                            <div class="summary-unit">kW (historyczna)</div>
                        </div>
                        <div class="summary-card highlight-green">
                            <div class="summary-label">Moc szczytowa PO</div>
                            <div class="summary-value" id="psPeakAfter">-</div>
                            <div class="summary-unit">kW (po redukcji)</div>
                        </div>
                        <div class="summary-card highlight-blue">
                            <div class="summary-label">Redukcja szczytu</div>
                            <div class="summary-value" id="psReduction">-</div>
                            <div class="summary-unit">kW / %</div>
                        </div>
                        <div class="summary-card highlight-orange">
                            <div class="summary-label">Pr√≥g Peak Shaving</div>
                            <div class="summary-value" id="psThreshold">-</div>
                            <div class="summary-unit">kW (P95 lub rƒôczny)</div>
                        </div>
                    </div>

                    <!-- Chart: Load Duration Curve with Peak Shaving -->
                    <div style="background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #0277bd;">üìä Krzywa obciƒÖ≈ºenia z redukcjƒÖ szczyt√≥w</h4>
                        <div class="chart-container" style="height: 350px;">
                            <canvas id="peakShavingChart"></canvas>
                        </div>
                        <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">
                            Czerwona linia = oryginalne zu≈ºycie | Zielona linia = po redukcji przez BESS | Przerywana = pr√≥g peak shaving
                        </p>
                    </div>

                    <!-- Detailed Calculations -->
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                        <h4 style="margin: 0 0 15px 0; color: #0277bd;">üßÆ Szczeg√≥≈Çowe obliczenia oszczƒôdno≈õci</h4>
                        <div id="psCalculations" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <!-- Filled by JS -->
                        </div>
                    </div>

                    <!-- Monthly Breakdown -->
                    <div style="background: #fff; border-radius: 12px; padding: 20px; margin-bottom: 25px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <h4 style="margin: 0 0 15px 0; color: #0277bd;">üìÖ Rozk≈Çad miesiƒôczny szczyt√≥w</h4>
                        <div class="table-container">
                            <table class="data-table" id="psMonthlyTable">
                                <thead>
                                    <tr>
                                        <th>MiesiƒÖc</th>
                                        <th>Szczyt PRZED [kW]</th>
                                        <th>Szczyt PO [kW]</th>
                                        <th>Redukcja [kW]</th>
                                        <th>Oszczƒôdno≈õƒá [PLN]</th>
                                    </tr>
                                </thead>
                                <tbody id="psMonthlyTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Export Button -->
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="exportPeakShavingReport()" style="padding: 12px 30px; background: linear-gradient(135deg, #0277bd, #01579b); color: white; border: none; border-radius: 8px; font-size: 1rem; font-weight: 600; cursor: pointer;">
                            üì• Eksportuj raport Peak Shaving do Excel
                        </button>
                    </div>
                </div>
            </div>

            <!-- BESS Recommendations Tab -->
            <div id="bessRecTab" class="tab-panel">
                <h3>Rekomendacje rozmiaru BESS</h3>
                <p class="description">Optymalne warianty rozmiaru magazynu dla Twojego profilu (symulacja PyPSA)</p>
                <div id="bessRecommendations"></div>
            </div>

            <!-- PV Recommendations Tab -->
            <div id="pvRecTab" class="tab-panel">
                <h3>Rekomendacje przewymiarowania PV</h3>
                <p class="description">Ile dodatkowego PV potrzeba dla lepszego wykorzystania BESS</p>
                <div id="pvRecommendations"></div>
            </div>

            <!-- Insights Tab -->
            <div id="insightsTab" class="tab-panel">
                <h3>Kluczowe wnioski</h3>
                <div id="insightsContent"></div>
            </div>
        </section>
    </div>

    <!-- Loading Overlay -->
    <div id="loading">
        <div class="spinner"></div>
        <p id="loadingText">Uruchamiam optymalizacjƒô PyPSA...</p>
    </div>

    <script src="profile.js?v=20251212-PEAK-ARBITRAGE"></script>
</body>
</html>
