version: '3.8'

services:
  # Data Analysis Service
  data-analysis:
    build:
      context: ./services/data-analysis
      dockerfile: Dockerfile
    container_name: pv-data-analysis
    ports:
      - "8001:8001"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8001/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PV Calculation Service
  pv-calculation:
    build:
      context: ./services/pv-calculation
      dockerfile: Dockerfile
    container_name: pv-calculation
    ports:
      - "8002:8002"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8002/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Economics Service
  economics:
    build:
      context: ./services/economics
      dockerfile: Dockerfile
    container_name: pv-economics
    ports:
      - "8003:8003"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8003/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Advanced Analytics Service
  advanced-analytics:
    build:
      context: ./services/advanced-analytics
      dockerfile: Dockerfile
    container_name: pv-advanced-analytics
    ports:
      - "8004:8004"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8004/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Typical Days Service
  typical-days:
    build:
      context: ./services/typical-days
      dockerfile: Dockerfile
    container_name: pv-typical-days
    ports:
      - "8005:8005"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8005/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Energy Prices Service (ENTSO-E)
  energy-prices:
    build:
      context: ./services/energy-prices
      dockerfile: Dockerfile
    container_name: pv-energy-prices
    ports:
      - "8010:8010"
    environment:
      - PYTHONUNBUFFERED=1
      - ENTSOE_API_KEY=${ENTSOE_API_KEY:-}
    volumes:
      - energy-prices-cache:/app/cache
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8010/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Shell (Main)
  frontend-shell:
    build:
      context: ./services/frontend-shell
      dockerfile: Dockerfile
    container_name: pv-frontend-shell
    ports:
      - "80:80"
    depends_on:
      - frontend-admin
      - frontend-config
      - frontend-consumption
      - frontend-production
      - frontend-comparison
      - frontend-economics
      - frontend-settings
      - frontend-esg
      - frontend-projects
      - frontend-hub
      - data-analysis
      - pv-calculation
      - economics
      - advanced-analytics
      - typical-days
      - projects-db
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Admin Module
  frontend-admin:
    build:
      context: ./services/frontend-admin
      dockerfile: Dockerfile
    container_name: pv-frontend-admin
    ports:
      - "9001:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Configuration Module
  frontend-config:
    build:
      context: ./services/frontend-config
      dockerfile: Dockerfile
    container_name: pv-frontend-config
    ports:
      - "9002:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Consumption Analysis Module
  frontend-consumption:
    build:
      context: ./services/frontend-consumption
      dockerfile: Dockerfile
    container_name: pv-frontend-consumption
    ports:
      - "9003:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PV Production Module
  frontend-production:
    build:
      context: ./services/frontend-production
      dockerfile: Dockerfile
    container_name: pv-frontend-production
    ports:
      - "9004:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Comparison Module
  frontend-comparison:
    build:
      context: ./services/frontend-comparison
      dockerfile: Dockerfile
    container_name: pv-frontend-comparison
    ports:
      - "9005:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Economics Module
  frontend-economics:
    build:
      context: ./services/frontend-economics
      dockerfile: Dockerfile
    container_name: pv-frontend-economics
    ports:
      - "9006:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # BESS Optimizer Service (PyPSA + HiGHS)
  bess-optimizer:
    build:
      context: ./services/bess-optimizer
      dockerfile: Dockerfile
    container_name: pv-bess-optimizer
    ports:
      - "8030:8030"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8030/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Settings Module
  frontend-settings:
    build:
      context: ./services/frontend-settings
      dockerfile: Dockerfile
    container_name: pv-frontend-settings
    ports:
      - "9007:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # ESG Module
  frontend-esg:
    build:
      context: ./services/frontend-esg
      dockerfile: Dockerfile
    container_name: pv-frontend-esg
    ports:
      - "9008:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Energy Prices Module
  frontend-energy-prices:
    build:
      context: ./services/frontend-energy-prices
      dockerfile: Dockerfile
    container_name: pv-frontend-energy-prices
    ports:
      - "9009:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Reports Service (PDF generation)
  reports:
    build:
      context: ./services/reports
      dockerfile: Dockerfile
    container_name: pv-reports
    ports:
      - "8011:8011"
    environment:
      - PYTHONUNBUFFERED=1
      - DATA_ANALYSIS_URL=http://pv-data-analysis:8001
      - PV_CALCULATION_URL=http://pv-calculation:8002
      - ECONOMICS_URL=http://pv-economics:8003
      - ADVANCED_ANALYTICS_URL=http://pv-advanced-analytics:8004
      - ENERGY_PRICES_URL=http://pv-energy-prices:8010
    volumes:
      - reports-output:/app/output
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8011/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Reports Frontend Module
  frontend-reports:
    build:
      context: ./services/frontend-reports
      dockerfile: Dockerfile
    container_name: pv-frontend-reports
    ports:
      - "9010:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Projects Database Service
  projects-db:
    build:
      context: ./services/projects-db
      dockerfile: Dockerfile
    container_name: pv-projects-db
    ports:
      - "8012:8012"
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_PATH=/app/data/projects.db
    volumes:
      - projects-data:/app/data
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8012/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Projects Frontend Module
  frontend-projects:
    build:
      context: ./services/frontend-projects
      dockerfile: Dockerfile
    container_name: pv-frontend-projects
    ports:
      - "9011:80"
    depends_on:
      - projects-db
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PVGIS Proxy Service (for Pxx calculation)
  pvgis-proxy:
    build:
      context: ./services/pvgis-proxy
      dockerfile: Dockerfile
    container_name: pv-pvgis-proxy
    ports:
      - "8020:8020"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8020/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Geo Service (Geocoding + Elevation)
  geo-service:
    build:
      context: ./services/geo-service
      dockerfile: Dockerfile
    container_name: pv-geo-service
    ports:
      - "8021:8021"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8021/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Quick Estimator Frontend Module
  frontend-estimator:
    build:
      context: ./services/frontend-estimator
      dockerfile: Dockerfile
    container_name: pv-frontend-estimator
    ports:
      - "9012:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # BESS (Battery Energy Storage System) Module
  frontend-bess:
    build:
      context: ./services/frontend-bess
      dockerfile: Dockerfile
    container_name: pv-frontend-bess
    ports:
      - "9013:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Profile Analysis Service (PV+BESS sizing optimization)
  profile-analysis:
    build:
      context: ./services/profile-analysis
      dockerfile: Dockerfile
    container_name: pv-profile-analysis
    ports:
      - "8040:8040"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8040/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # Profile Analysis Frontend Module
  frontend-profile:
    build:
      context: ./services/frontend-profile
      dockerfile: Dockerfile
    container_name: pv-frontend-profile
    ports:
      - "9014:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Hub Module (Analysis Dashboard)
  frontend-hub:
    build:
      context: ./services/frontend-hub
      dockerfile: Dockerfile
    container_name: pv-frontend-hub
    ports:
      - "9015:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PostgreSQL Database
  postgres:
    image: postgres:16-alpine
    container_name: pv-postgres
    environment:
      - POSTGRES_USER=pvanalyzer
      - POSTGRES_PASSWORD=pvanalyzer123
      - POSTGRES_DB=pvanalyzer
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - ./services/database-api/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pvanalyzer"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # Database API Service
  database-api:
    build:
      context: ./services/database-api
      dockerfile: Dockerfile
    container_name: pv-database-api
    ports:
      - "8050:8050"
    environment:
      - PYTHONUNBUFFERED=1
      - DATABASE_URL=postgresql://pvanalyzer:pvanalyzer123@pv-postgres:5432/pvanalyzer
    depends_on:
      - postgres
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8050/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

networks:
  pv-network:
    driver: bridge
    name: pv-optimizer-network

volumes:
  data-volume:
    name: pv-data-volume
  energy-prices-cache:
    name: pv-energy-prices-cache
  reports-output:
    name: pv-reports-output
  projects-data:
    name: pv-projects-data
  postgres-data:
    name: pv-postgres-data
