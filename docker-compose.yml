version: '3.8'

services:
  # Data Analysis Service
  data-analysis:
    build:
      context: ./services/data-analysis
      dockerfile: Dockerfile
    container_name: pv-data-analysis
    ports:
      - "8001:8001"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PV Calculation Service
  pv-calculation:
    build:
      context: ./services/pv-calculation
      dockerfile: Dockerfile
    container_name: pv-calculation
    ports:
      - "8002:8002"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Economics Service
  economics:
    build:
      context: ./services/economics
      dockerfile: Dockerfile
    container_name: pv-economics
    ports:
      - "8003:8003"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Advanced Analytics Service
  advanced-analytics:
    build:
      context: ./services/advanced-analytics
      dockerfile: Dockerfile
    container_name: pv-advanced-analytics
    ports:
      - "8004:8004"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8004/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Typical Days Service
  typical-days:
    build:
      context: ./services/typical-days
      dockerfile: Dockerfile
    container_name: pv-typical-days
    ports:
      - "8005:8005"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8005/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Energy Prices Service (ENTSO-E)
  energy-prices:
    build:
      context: ./services/energy-prices
      dockerfile: Dockerfile
    container_name: pv-energy-prices
    ports:
      - "8010:8010"
    environment:
      - PYTHONUNBUFFERED=1
      - ENTSOE_API_KEY=${ENTSOE_API_KEY:-}
    volumes:
      - energy-prices-cache:/app/cache
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Frontend Shell (Main)
  frontend-shell:
    build:
      context: ./services/frontend-shell
      dockerfile: Dockerfile
    container_name: pv-frontend-shell
    ports:
      - "80:80"
    depends_on:
      - frontend-admin
      - frontend-config
      - frontend-consumption
      - frontend-production
      - frontend-comparison
      - frontend-economics
      - frontend-settings
      - frontend-insights
      - data-analysis
      - pv-calculation
      - economics
      - advanced-analytics
      - typical-days
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Admin Module
  frontend-admin:
    build:
      context: ./services/frontend-admin
      dockerfile: Dockerfile
    container_name: pv-frontend-admin
    ports:
      - "9001:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Configuration Module
  frontend-config:
    build:
      context: ./services/frontend-config
      dockerfile: Dockerfile
    container_name: pv-frontend-config
    ports:
      - "9002:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Consumption Analysis Module
  frontend-consumption:
    build:
      context: ./services/frontend-consumption
      dockerfile: Dockerfile
    container_name: pv-frontend-consumption
    ports:
      - "9003:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PV Production Module
  frontend-production:
    build:
      context: ./services/frontend-production
      dockerfile: Dockerfile
    container_name: pv-frontend-production
    ports:
      - "9004:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Comparison Module
  frontend-comparison:
    build:
      context: ./services/frontend-comparison
      dockerfile: Dockerfile
    container_name: pv-frontend-comparison
    ports:
      - "9005:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Economics Module
  frontend-economics:
    build:
      context: ./services/frontend-economics
      dockerfile: Dockerfile
    container_name: pv-frontend-economics
    ports:
      - "9006:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Settings Module
  frontend-settings:
    build:
      context: ./services/frontend-settings
      dockerfile: Dockerfile
    container_name: pv-frontend-settings
    ports:
      - "9007:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Insights Module
  frontend-insights:
    build:
      context: ./services/frontend-insights
      dockerfile: Dockerfile
    container_name: pv-frontend-insights
    ports:
      - "9008:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Energy Prices Module
  frontend-energy-prices:
    build:
      context: ./services/frontend-energy-prices
      dockerfile: Dockerfile
    container_name: pv-frontend-energy-prices
    ports:
      - "9009:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Reports Service (PDF generation)
  reports:
    build:
      context: ./services/reports
      dockerfile: Dockerfile
    container_name: pv-reports
    ports:
      - "8011:8011"
    environment:
      - PYTHONUNBUFFERED=1
      - DATA_ANALYSIS_URL=http://pv-data-analysis:8001
      - PV_CALCULATION_URL=http://pv-calculation:8002
      - ECONOMICS_URL=http://pv-economics:8003
      - ADVANCED_ANALYTICS_URL=http://pv-advanced-analytics:8004
      - ENERGY_PRICES_URL=http://pv-energy-prices:8010
    volumes:
      - reports-output:/app/output
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8011/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # Reports Frontend Module
  frontend-reports:
    build:
      context: ./services/frontend-reports
      dockerfile: Dockerfile
    container_name: pv-frontend-reports
    ports:
      - "9010:80"
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # PVGIS Proxy Service (for Pxx calculation)
  pvgis-proxy:
    build:
      context: ./services/pvgis-proxy
      dockerfile: Dockerfile
    container_name: pv-pvgis-proxy
    ports:
      - "8020:8020"
    environment:
      - PYTHONUNBUFFERED=1
    networks:
      - pv-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8020/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

networks:
  pv-network:
    driver: bridge
    name: pv-optimizer-network

volumes:
  data-volume:
    name: pv-data-volume
  energy-prices-cache:
    name: pv-energy-prices-cache
  reports-output:
    name: pv-reports-output
